name: Test ARM

on:
  push:
    branches:
      - main
  pull_request:
    branches:    
      - main


jobs:
  test-template:
    name: Test ARM (Neo4j Cluster)
    runs-on: ubuntu-latest
    env:
      ResourceGroupLocation: westeurope
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Configure Resource Group and Deployment variables
      id: variables
      run: |
        DATE=`echo $(date '+%Y%m%d-%S')`
        RGNAME=`echo ghactions-rg-$DATE`
        DEPNAME=`echo ghactions-dep-$DATE`
        echo "Resource Group name: $RGNAME"
        echo "rgName=$RGNAME" >> $GITHUB_OUTPUT
        echo "depName=$DEPNAME" >> $GITHUB_OUTPUT

    - name: Create Resource Group
      uses: Azure/CLI@v1
      id: rgCreate
      with:
        inlineScript: |
          #!/bin/bash   
          az group create --name ${{ steps.variables.outputs.rgName }} --location ${{ env.ResourceGroupLocation }}
          echo "Azure resource group created"

    - uses: azure/arm-deploy@v1
      with:
        resourceGroupName: ${{ steps.variables.outputs.rgName }}
        template: ./marketplace/mainTemplate.json
        parameters: ./marketplace/parameters.json
        deploymentName: ${{ steps.variables.outputs.depName }}

#    - name: Retrieve Neo4j URI
#      id: uri
#      run: |
#        URI=`aws cloudformation describe-stacks --region ${AWS_REGION} --query "Stacks[?StackName=='${{ steps.stack-name.outputs.stackname }}'][].Outputs[?OutputKey=='Neo4jURI'].OutputValue" --output text`
#        echo "Neo4j URI: $URI"
#        echo "::set-output name=uri::$URI"
#
#    - name: Execute tests
#      run: |
#        ./marketplace/neo4jtester_linux "${{ steps.uri.outputs.uri }}" "neo4j" "foobar123%"
#
#    - name: Delete CloudFormation Stack
#      if: always()
#      run: |
#        aws cloudformation delete-stack --stack-name ${{ steps.stack-name.outputs.stackname }}
#        while true
#        do
#          STACK_STATUS=`aws cloudformation describe-stacks --region us-east-1 --query "Stacks[?StackName=='${{ steps.stack-name.outputs.stackname }}'].StackStatus" --output text`
#          echo "Printing stack status := ${STACK_STATUS}"
#          if [[ ${STACK_STATUS} == "DELETE_IN_PROGRESS" ]]; then
#            echo "Sleeping for a minute...be right back !!"
#            sleep 60
#            continue
#          else
#            echo "Cloudformation stack is deleted !!"
#            break
#          fi
#        done

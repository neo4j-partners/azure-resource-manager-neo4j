{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "8320610326001325896"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources. Defaults to resource group location."
      }
    },
    "resourceNamePrefix": {
      "type": "string",
      "defaultValue": "neo4j",
      "minLength": 3,
      "maxLength": 10,
      "metadata": {
        "description": "Prefix for all resource names. Used to create unique identifiers."
      }
    },
    "kubernetesVersion": {
      "type": "string",
      "defaultValue": "1.30",
      "metadata": {
        "description": "Kubernetes version for the AKS cluster."
      }
    },
    "systemNodeSize": {
      "type": "string",
      "defaultValue": "Standard_D2s_v5",
      "metadata": {
        "description": "VM size for system node pool (Kubernetes services)."
      }
    },
    "userNodeSize": {
      "type": "string",
      "defaultValue": "Standard_E4s_v5",
      "metadata": {
        "description": "VM size for user node pool (Neo4j workloads)."
      }
    },
    "userNodeCountMin": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 1,
      "maxValue": 10,
      "metadata": {
        "description": "Minimum number of nodes in user node pool."
      }
    },
    "userNodeCountMax": {
      "type": "int",
      "defaultValue": 10,
      "minValue": 1,
      "maxValue": 10,
      "metadata": {
        "description": "Maximum number of nodes in user node pool."
      }
    },
    "nodeCount": {
      "type": "int",
      "defaultValue": 1,
      "allowedValues": [
        1,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10
      ],
      "metadata": {
        "description": "Number of Neo4j instances to deploy (1 for standalone, 3-10 for cluster)."
      }
    },
    "graphDatabaseVersion": {
      "type": "string",
      "defaultValue": "5",
      "allowedValues": [
        "5",
        "4.4"
      ],
      "metadata": {
        "description": "Neo4j graph database version."
      }
    },
    "diskSize": {
      "type": "int",
      "defaultValue": 32,
      "minValue": 32,
      "maxValue": 4096,
      "metadata": {
        "description": "Size of data disk per Neo4j instance in GB."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "minLength": 8,
      "metadata": {
        "description": "Neo4j admin password. Must be at least 8 characters."
      }
    },
    "licenseType": {
      "type": "string",
      "defaultValue": "Evaluation",
      "allowedValues": [
        "Enterprise",
        "Evaluation"
      ],
      "metadata": {
        "description": "Neo4j license type."
      }
    },
    "installGraphDataScience": {
      "type": "string",
      "defaultValue": "No",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "description": "Install Graph Data Science plugin."
      }
    },
    "graphDataScienceLicenseKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Graph Data Science license key (if installing GDS)."
      }
    },
    "installBloom": {
      "type": "string",
      "defaultValue": "No",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "description": "Install Bloom plugin."
      }
    },
    "bloomLicenseKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Bloom license key (if installing Bloom)."
      }
    }
  },
  "variables": {
    "deploymentUniqueString": "[substring(uniqueString(resourceGroup().id), 0, 6)]",
    "clusterName": "[format('{0}-aks-{1}', parameters('resourceNamePrefix'), variables('deploymentUniqueString'))]",
    "identityName": "[format('{0}-identity-{1}', parameters('resourceNamePrefix'), variables('deploymentUniqueString'))]",
    "namespacePrefix": "neo4j",
    "isCluster": "[greaterOrEquals(parameters('nodeCount'), 3)]",
    "deploymentType": "[if(variables('isCluster'), 'cluster', 'standalone')]",
    "commonTags": {
      "neo4j-version": "[parameters('graphDatabaseVersion')]",
      "neo4j-edition": "enterprise",
      "deployment-type": "aks",
      "deployment-mode": "[variables('deploymentType')]",
      "node-count": "[string(parameters('nodeCount'))]",
      "created-by": "neo4j-azure-marketplace",
      "managed-by": "bicep"
    },
    "initialUserNodeCount": "[parameters('nodeCount')]"
  },
  "resources": {
    "network": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceNamePrefix": {
            "value": "[parameters('resourceNamePrefix')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6575308329173336084"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "resourceNamePrefix": {
              "type": "string",
              "metadata": {
                "description": "Prefix for resource names"
              }
            },
            "vnetAddressSpace": {
              "type": "string",
              "defaultValue": "10.0.0.0/8",
              "metadata": {
                "description": "Address space for virtual network"
              }
            },
            "systemSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.0.0/16",
              "metadata": {
                "description": "Address prefix for system node pool subnet"
              }
            },
            "userSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.1.0.0/16",
              "metadata": {
                "description": "Address prefix for user node pool subnet"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}-vnet', parameters('resourceNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressSpace')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "system-subnet",
                    "properties": {
                      "addressPrefix": "[parameters('systemSubnetPrefix')]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "user-subnet",
                    "properties": {
                      "addressPrefix": "[parameters('userSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg', parameters('resourceNamePrefix')))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled",
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage"
                        },
                        {
                          "service": "Microsoft.KeyVault"
                        }
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg', parameters('resourceNamePrefix')))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}-nsg', parameters('resourceNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowNeo4jBolt",
                    "properties": {
                      "description": "Allow Neo4j Bolt protocol (client connections)",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7687",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowNeo4jHTTP",
                    "properties": {
                      "description": "Allow Neo4j Browser HTTP",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7474",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 101,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowNeo4jHTTPS",
                    "properties": {
                      "description": "Allow Neo4j Browser HTTPS",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7473",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 102,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowNeo4jClusterTransaction",
                    "properties": {
                      "description": "Allow Neo4j cluster transaction shipping",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "6000",
                      "sourceAddressPrefix": "[parameters('userSubnetPrefix')]",
                      "destinationAddressPrefix": "[parameters('userSubnetPrefix')]",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowNeo4jClusterRaft",
                    "properties": {
                      "description": "Allow Neo4j cluster Raft consensus",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7000",
                      "sourceAddressPrefix": "[parameters('userSubnetPrefix')]",
                      "destinationAddressPrefix": "[parameters('userSubnetPrefix')]",
                      "access": "Allow",
                      "priority": 111,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowAzureLoadBalancerInbound",
                    "properties": {
                      "description": "Allow Azure Load Balancer health probes",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "description": "Deny all other inbound traffic",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 4096,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowAllOutbound",
                    "properties": {
                      "description": "Allow all outbound traffic (Azure services accessed via service endpoints)",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', format('{0}-vnet', parameters('resourceNamePrefix')))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[format('{0}-vnet', parameters('resourceNamePrefix'))]"
            },
            "systemSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', format('{0}-vnet', parameters('resourceNamePrefix'))), '2023-11-01').subnets[0].id]"
            },
            "systemSubnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', format('{0}-vnet', parameters('resourceNamePrefix'))), '2023-11-01').subnets[0].name]"
            },
            "userSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', format('{0}-vnet', parameters('resourceNamePrefix'))), '2023-11-01').subnets[1].id]"
            },
            "userSubnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', format('{0}-vnet', parameters('resourceNamePrefix'))), '2023-11-01').subnets[1].name]"
            },
            "nsgId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg', parameters('resourceNamePrefix')))]"
            },
            "nsgName": {
              "type": "string",
              "value": "[format('{0}-nsg', parameters('resourceNamePrefix'))]"
            }
          }
        }
      }
    },
    "identity": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "identity-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "identityName": {
            "value": "[variables('identityName')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8066549291953551079"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "Name for the managed identity"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-07-31-preview",
              "name": "[parameters('identityName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "identityId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
            },
            "identityName": {
              "type": "string",
              "value": "[parameters('identityName')]"
            },
            "clientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-07-31-preview').clientId]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-07-31-preview').principalId]"
            }
          }
        }
      }
    },
    "aksCluster": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "aks-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "clusterName": {
            "value": "[variables('clusterName')]"
          },
          "kubernetesVersion": {
            "value": "[parameters('kubernetesVersion')]"
          },
          "systemSubnetId": {
            "value": "[reference('network').outputs.systemSubnetId.value]"
          },
          "userSubnetId": {
            "value": "[reference('network').outputs.userSubnetId.value]"
          },
          "identityId": {
            "value": "[reference('identity').outputs.identityId.value]"
          },
          "identityPrincipalId": {
            "value": "[reference('identity').outputs.principalId.value]"
          },
          "systemNodeSize": {
            "value": "[parameters('systemNodeSize')]"
          },
          "userNodeSize": {
            "value": "[parameters('userNodeSize')]"
          },
          "userNodeCountMin": {
            "value": "[parameters('userNodeCountMin')]"
          },
          "userNodeCountMax": {
            "value": "[parameters('userNodeCountMax')]"
          },
          "userNodeCount": {
            "value": "[variables('initialUserNodeCount')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6753351069026095343"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "clusterName": {
              "type": "string",
              "metadata": {
                "description": "Name for the AKS cluster"
              }
            },
            "kubernetesVersion": {
              "type": "string",
              "defaultValue": "1.31",
              "metadata": {
                "description": "Kubernetes version"
              }
            },
            "systemSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the system subnet"
              }
            },
            "userSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the user subnet"
              }
            },
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the managed identity"
              }
            },
            "identityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the managed identity"
              }
            },
            "systemNodeSize": {
              "type": "string",
              "defaultValue": "Standard_D2s_v5",
              "metadata": {
                "description": "VM size for system node pool"
              }
            },
            "userNodeSize": {
              "type": "string",
              "defaultValue": "Standard_E4s_v5",
              "metadata": {
                "description": "VM size for user node pool"
              }
            },
            "userNodeCountMin": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Minimum node count for user node pool"
              }
            },
            "userNodeCountMax": {
              "type": "int",
              "defaultValue": 10,
              "metadata": {
                "description": "Maximum node count for user node pool"
              }
            },
            "userNodeCount": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Initial node count for user node pool"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "aksClusterUserRoleId": "4abbcc35-e782-43d8-92c5-2d3f1bd2253f"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}-logs', parameters('clusterName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              }
            },
            {
              "type": "Microsoft.ContainerService/managedClusters",
              "apiVersion": "2024-02-01",
              "name": "[parameters('clusterName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identityId'))]": {}
                }
              },
              "properties": {
                "kubernetesVersion": "[parameters('kubernetesVersion')]",
                "dnsPrefix": "[format('{0}-dns', parameters('clusterName'))]",
                "oidcIssuerProfile": {
                  "enabled": true
                },
                "securityProfile": {
                  "workloadIdentity": {
                    "enabled": true
                  }
                },
                "agentPoolProfiles": [
                  {
                    "name": "system",
                    "count": 3,
                    "vmSize": "[parameters('systemNodeSize')]",
                    "osType": "Linux",
                    "osSKU": "AzureLinux",
                    "mode": "System",
                    "vnetSubnetID": "[parameters('systemSubnetId')]",
                    "enableAutoScaling": false,
                    "type": "VirtualMachineScaleSets",
                    "nodeTaints": [
                      "CriticalAddonsOnly=true:NoSchedule"
                    ],
                    "nodeLabels": {
                      "nodepool-type": "system"
                    }
                  },
                  {
                    "name": "user",
                    "count": "[parameters('userNodeCount')]",
                    "minCount": "[parameters('userNodeCountMin')]",
                    "maxCount": "[parameters('userNodeCountMax')]",
                    "vmSize": "[parameters('userNodeSize')]",
                    "osType": "Linux",
                    "osSKU": "AzureLinux",
                    "mode": "User",
                    "vnetSubnetID": "[parameters('userSubnetId')]",
                    "enableAutoScaling": true,
                    "type": "VirtualMachineScaleSets",
                    "nodeLabels": {
                      "nodepool-type": "user",
                      "workload": "neo4j"
                    },
                    "tags": {
                      "workload": "neo4j"
                    }
                  }
                ],
                "networkProfile": {
                  "networkPlugin": "azure",
                  "networkPolicy": "azure",
                  "loadBalancerSku": "standard",
                  "outboundType": "loadBalancer",
                  "serviceCidr": "172.16.0.0/16",
                  "dnsServiceIP": "172.16.0.10"
                },
                "addonProfiles": {
                  "omsagent": {
                    "enabled": true,
                    "config": {
                      "logAnalyticsWorkspaceResourceID": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('clusterName')))]"
                    }
                  },
                  "azurePolicy": {
                    "enabled": true
                  }
                },
                "autoUpgradeProfile": {
                  "upgradeChannel": "stable"
                },
                "disableLocalAccounts": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('clusterName')))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.ContainerService/managedClusters/{0}', parameters('clusterName'))]",
              "name": "[format('{0}-diagnostics', parameters('clusterName'))]",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('clusterName')))]",
                "logs": [
                  {
                    "category": "kube-apiserver",
                    "enabled": true
                  },
                  {
                    "category": "kube-controller-manager",
                    "enabled": true
                  },
                  {
                    "category": "kube-scheduler",
                    "enabled": true
                  },
                  {
                    "category": "kube-audit",
                    "enabled": true
                  },
                  {
                    "category": "cluster-autoscaler",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName'))]",
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('clusterName')))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerService/managedClusters/{0}', parameters('clusterName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName')), parameters('identityPrincipalId'), 'aks-cluster-user')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('aksClusterUserRoleId'))]",
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName'))]"
              ]
            }
          ],
          "outputs": {
            "clusterId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName'))]"
            },
            "clusterName": {
              "type": "string",
              "value": "[parameters('clusterName')]"
            },
            "oidcIssuerUrl": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName')), '2024-02-01').oidcIssuerProfile.issuerURL]"
            },
            "kubeletIdentityObjectId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName')), '2024-02-01').identityProfile.kubeletidentity.objectId]"
            },
            "nodeResourceGroup": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName')), '2024-02-01').nodeResourceGroup]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('clusterName')))]"
            },
            "fqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName')), '2024-02-01').fqdn]"
            }
          }
        }
      },
      "dependsOn": [
        "identity",
        "network"
      ]
    },
    "storage": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "aksClusterName": {
            "value": "[reference('aksCluster').outputs.clusterName.value]"
          },
          "aksResourceGroup": {
            "value": "[resourceGroup().name]"
          },
          "storageClassName": {
            "value": "neo4j-premium"
          },
          "identityId": {
            "value": "[reference('identity').outputs.identityId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3202734491184374820"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for deployment scripts"
              }
            },
            "aksClusterName": {
              "type": "string",
              "metadata": {
                "description": "Name of the AKS cluster"
              }
            },
            "aksResourceGroup": {
              "type": "string",
              "metadata": {
                "description": "Resource group containing the AKS cluster"
              }
            },
            "storageClassName": {
              "type": "string",
              "defaultValue": "neo4j-premium",
              "metadata": {
                "description": "Name for the StorageClass"
              }
            },
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "Managed identity for deployment script"
              }
            }
          },
          "variables": {
            "storageClassYaml": "[format('apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: {0}\nprovisioner: disk.csi.azure.com\nparameters:\n  skuName: Premium_LRS\n  kind: Managed\n  cachingMode: ReadOnly\nreclaimPolicy: Retain\nallowVolumeExpansion: true\nvolumeBindingMode: WaitForFirstConsumer\n', parameters('storageClassName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "[format('create-storageclass-{0}', uniqueString(resourceGroup().id))]",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identityId'))]": {}
                }
              },
              "properties": {
                "azCliVersion": "2.50.0",
                "timeout": "PT10M",
                "retentionInterval": "PT1H",
                "environmentVariables": [
                  {
                    "name": "AKS_CLUSTER_NAME",
                    "value": "[parameters('aksClusterName')]"
                  },
                  {
                    "name": "AKS_RESOURCE_GROUP",
                    "value": "[parameters('aksResourceGroup')]"
                  },
                  {
                    "name": "STORAGE_CLASS_YAML",
                    "value": "[variables('storageClassYaml')]"
                  }
                ],
                "scriptContent": "      #!/bin/bash\n      set -e\n\n      echo \"Installing kubectl...\"\n      az aks install-cli\n\n      echo \"Getting AKS credentials...\"\n      az aks get-credentials --name $AKS_CLUSTER_NAME --resource-group $AKS_RESOURCE_GROUP --overwrite-existing\n\n      echo \"Creating StorageClass...\"\n      echo \"$STORAGE_CLASS_YAML\" | kubectl apply -f -\n\n      echo \"Verifying StorageClass...\"\n      kubectl get storageclass ${storageClassName}\n\n      echo \"StorageClass created successfully\"\n    ",
                "cleanupPreference": "OnSuccess"
              }
            }
          ],
          "outputs": {
            "storageClassName": {
              "type": "string",
              "value": "[parameters('storageClassName')]"
            },
            "deploymentStatus": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('create-storageclass-{0}', uniqueString(resourceGroup().id))), '2023-08-01').provisioningState]"
            }
          }
        }
      },
      "dependsOn": [
        "aksCluster",
        "identity"
      ]
    },
    "neo4jApp": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "neo4j-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "aksClusterName": {
            "value": "[reference('aksCluster').outputs.clusterName.value]"
          },
          "aksResourceGroup": {
            "value": "[resourceGroup().name]"
          },
          "identityId": {
            "value": "[reference('identity').outputs.identityId.value]"
          },
          "namespaceName": {
            "value": "[variables('namespacePrefix')]"
          },
          "serviceAccountName": {
            "value": "neo4j-sa"
          },
          "statefulSetName": {
            "value": "neo4j"
          },
          "serviceName": {
            "value": "neo4j"
          },
          "replicas": {
            "value": "[parameters('nodeCount')]"
          },
          "graphDatabaseVersion": {
            "value": "[parameters('graphDatabaseVersion')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "licenseType": {
            "value": "[parameters('licenseType')]"
          },
          "diskSize": {
            "value": "[parameters('diskSize')]"
          },
          "installGraphDataScience": {
            "value": "[equals(parameters('installGraphDataScience'), 'Yes')]"
          },
          "installBloom": {
            "value": "[equals(parameters('installBloom'), 'Yes')]"
          },
          "cpuRequest": {
            "value": "2"
          },
          "memoryRequest": {
            "value": "8Gi"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13855618240729183528"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for deployment scripts"
              }
            },
            "aksClusterName": {
              "type": "string",
              "metadata": {
                "description": "Name of the AKS cluster"
              }
            },
            "aksResourceGroup": {
              "type": "string",
              "metadata": {
                "description": "Resource group containing the AKS cluster"
              }
            },
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "Managed identity ID for deployment scripts"
              }
            },
            "namespaceName": {
              "type": "string",
              "defaultValue": "neo4j",
              "metadata": {
                "description": "Kubernetes namespace name"
              }
            },
            "serviceAccountName": {
              "type": "string",
              "defaultValue": "neo4j-sa",
              "metadata": {
                "description": "Service account name"
              }
            },
            "statefulSetName": {
              "type": "string",
              "defaultValue": "neo4j",
              "metadata": {
                "description": "StatefulSet name"
              }
            },
            "serviceName": {
              "type": "string",
              "defaultValue": "neo4j",
              "metadata": {
                "description": "Service name"
              }
            },
            "replicas": {
              "type": "int",
              "metadata": {
                "description": "Number of Neo4j replicas"
              }
            },
            "graphDatabaseVersion": {
              "type": "string",
              "metadata": {
                "description": "Neo4j graph database version"
              }
            },
            "adminPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Neo4j admin password"
              }
            },
            "licenseType": {
              "type": "string",
              "allowedValues": [
                "Enterprise",
                "Evaluation"
              ],
              "metadata": {
                "description": "Neo4j license type"
              }
            },
            "diskSize": {
              "type": "int",
              "metadata": {
                "description": "Size of data disk per pod in GB"
              }
            },
            "installGraphDataScience": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Install Graph Data Science plugin"
              }
            },
            "installBloom": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Install Bloom plugin"
              }
            },
            "cpuRequest": {
              "type": "string",
              "defaultValue": "2",
              "metadata": {
                "description": "CPU request per pod"
              }
            },
            "memoryRequest": {
              "type": "string",
              "defaultValue": "8Gi",
              "metadata": {
                "description": "Memory request per pod"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "helm-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "aksResourceGroup": {
                    "value": "[parameters('aksResourceGroup')]"
                  },
                  "namespaceName": {
                    "value": "[parameters('namespaceName')]"
                  },
                  "releaseName": {
                    "value": "[parameters('serviceName')]"
                  },
                  "nodeCount": {
                    "value": "[parameters('replicas')]"
                  },
                  "graphDatabaseVersion": {
                    "value": "[parameters('graphDatabaseVersion')]"
                  },
                  "adminPassword": {
                    "value": "[parameters('adminPassword')]"
                  },
                  "licenseType": {
                    "value": "[parameters('licenseType')]"
                  },
                  "diskSize": {
                    "value": "[parameters('diskSize')]"
                  },
                  "cpuRequest": {
                    "value": "[format('{0}000m', parameters('cpuRequest'))]"
                  },
                  "memoryRequest": {
                    "value": "[parameters('memoryRequest')]"
                  },
                  "installGraphDataScience": {
                    "value": "[parameters('installGraphDataScience')]"
                  },
                  "installBloom": {
                    "value": "[parameters('installBloom')]"
                  },
                  "identityId": {
                    "value": "[parameters('identityId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "3914373473281519224"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for deployment scripts"
                      }
                    },
                    "aksClusterName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the AKS cluster"
                      }
                    },
                    "aksResourceGroup": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource group containing the AKS cluster"
                      }
                    },
                    "namespaceName": {
                      "type": "string",
                      "defaultValue": "neo4j",
                      "metadata": {
                        "description": "Kubernetes namespace for Neo4j"
                      }
                    },
                    "releaseName": {
                      "type": "string",
                      "defaultValue": "neo4j",
                      "metadata": {
                        "description": "Helm release name"
                      }
                    },
                    "nodeCount": {
                      "type": "int",
                      "minValue": 1,
                      "maxValue": 10,
                      "metadata": {
                        "description": "Number of Neo4j nodes (1 for standalone, 3+ for cluster)"
                      }
                    },
                    "graphDatabaseVersion": {
                      "type": "string",
                      "metadata": {
                        "description": "Neo4j graph database version"
                      }
                    },
                    "adminPassword": {
                      "type": "securestring",
                      "metadata": {
                        "description": "Neo4j admin password"
                      }
                    },
                    "licenseType": {
                      "type": "string",
                      "allowedValues": [
                        "Enterprise",
                        "Evaluation"
                      ],
                      "metadata": {
                        "description": "Neo4j license type"
                      }
                    },
                    "diskSize": {
                      "type": "int",
                      "metadata": {
                        "description": "Size of data disk per pod in GB"
                      }
                    },
                    "cpuRequest": {
                      "type": "string",
                      "defaultValue": "2000m",
                      "metadata": {
                        "description": "CPU request per pod (in millicores)"
                      }
                    },
                    "memoryRequest": {
                      "type": "string",
                      "defaultValue": "8Gi",
                      "metadata": {
                        "description": "Memory request per pod"
                      }
                    },
                    "installGraphDataScience": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Install Graph Data Science plugin"
                      }
                    },
                    "installBloom": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Install Bloom plugin"
                      }
                    },
                    "identityId": {
                      "type": "string",
                      "metadata": {
                        "description": "Managed identity for deployment script"
                      }
                    }
                  },
                  "variables": {
                    "isCluster": "[greaterOrEquals(parameters('nodeCount'), 3)]",
                    "clusterName": "[if(variables('isCluster'), 'neo4j-cluster', 'neo4j-standalone')]",
                    "licenseAgreement": "[if(equals(parameters('licenseType'), 'Evaluation'), 'eval', 'yes')]",
                    "helmChartRepo": "https://helm.neo4j.com/neo4j",
                    "helmChartName": "neo4j/neo4j",
                    "helmChartVersion": "5.26.16",
                    "storageClassName": "neo4j-premium",
                    "storageSizeGi": "[format('{0}Gi', parameters('diskSize'))]",
                    "heapSizeGb": "4G",
                    "pageCacheSizeGb": "3G",
                    "pluginsList": "[concat(if(parameters('installGraphDataScience'), createArray('graph-data-science'), createArray()), if(parameters('installBloom'), createArray('bloom'), createArray()))]",
                    "pluginsEnabled": "[if(greater(length(variables('pluginsList')), 0), 'true', 'false')]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[format('helm-install-{0}', uniqueString(resourceGroup().id, parameters('namespaceName'), parameters('releaseName')))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('identityId'))]": {}
                        }
                      },
                      "properties": {
                        "azCliVersion": "2.50.0",
                        "timeout": "PT30M",
                        "retentionInterval": "PT1H",
                        "environmentVariables": [
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "AKS_RESOURCE_GROUP",
                            "value": "[parameters('aksResourceGroup')]"
                          },
                          {
                            "name": "NAMESPACE_NAME",
                            "value": "[parameters('namespaceName')]"
                          },
                          {
                            "name": "RELEASE_NAME",
                            "value": "[parameters('releaseName')]"
                          },
                          {
                            "name": "HELM_CHART_REPO",
                            "value": "[variables('helmChartRepo')]"
                          },
                          {
                            "name": "HELM_CHART_NAME",
                            "value": "[variables('helmChartName')]"
                          },
                          {
                            "name": "HELM_CHART_VERSION",
                            "value": "[variables('helmChartVersion')]"
                          },
                          {
                            "name": "NEO4J_PASSWORD",
                            "secureValue": "[parameters('adminPassword')]"
                          },
                          {
                            "name": "NEO4J_VERSION",
                            "value": "[parameters('graphDatabaseVersion')]"
                          },
                          {
                            "name": "LICENSE_AGREEMENT",
                            "value": "[variables('licenseAgreement')]"
                          },
                          {
                            "name": "CLUSTER_NAME",
                            "value": "[variables('clusterName')]"
                          },
                          {
                            "name": "IS_CLUSTER",
                            "value": "[string(variables('isCluster'))]"
                          },
                          {
                            "name": "NODE_COUNT",
                            "value": "[string(parameters('nodeCount'))]"
                          },
                          {
                            "name": "STORAGE_CLASS",
                            "value": "[variables('storageClassName')]"
                          },
                          {
                            "name": "STORAGE_SIZE",
                            "value": "[variables('storageSizeGi')]"
                          },
                          {
                            "name": "CPU_REQUEST",
                            "value": "[parameters('cpuRequest')]"
                          },
                          {
                            "name": "MEMORY_REQUEST",
                            "value": "[parameters('memoryRequest')]"
                          },
                          {
                            "name": "HEAP_SIZE",
                            "value": "[variables('heapSizeGb')]"
                          },
                          {
                            "name": "PAGECACHE_SIZE",
                            "value": "[variables('pageCacheSizeGb')]"
                          },
                          {
                            "name": "PLUGINS_ENABLED",
                            "value": "[variables('pluginsEnabled')]"
                          }
                        ],
                        "scriptContent": "      #!/bin/bash\n      set -e\n\n      echo \"====================================\"\n      echo \"Neo4j Helm Chart Deployment\"\n      echo \"====================================\"\n      echo \"Release: $RELEASE_NAME\"\n      echo \"Namespace: $NAMESPACE_NAME\"\n      echo \"Cluster Mode: $IS_CLUSTER\"\n      echo \"Node Count: $NODE_COUNT\"\n      echo \"\"\n\n      # Install kubectl\n      echo \"Installing kubectl...\"\n      az aks install-cli\n\n      # Get AKS credentials\n      echo \"Getting AKS credentials...\"\n      az aks get-credentials --name $AKS_CLUSTER_NAME --resource-group $AKS_RESOURCE_GROUP --overwrite-existing\n\n      # Install Helm\n      echo \"Installing Helm...\"\n      curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash\n\n      # Add Neo4j Helm repository\n      echo \"Adding Neo4j Helm repository...\"\n      helm repo add neo4j $HELM_CHART_REPO\n      helm repo update\n\n      # Create namespace if it doesn't exist\n      echo \"Creating namespace: $NAMESPACE_NAME\"\n      kubectl create namespace $NAMESPACE_NAME --dry-run=client -o yaml | kubectl apply -f -\n\n      echo \"\"\n      echo \"Installing Neo4j Helm Chart version $HELM_CHART_VERSION...\"\n      echo \"\"\n\n      # Build Helm command with corrected parameter names\n      HELM_CMD=\"helm upgrade --install $RELEASE_NAME $HELM_CHART_NAME\"\n      HELM_CMD=\"$HELM_CMD --version $HELM_CHART_VERSION\"\n      HELM_CMD=\"$HELM_CMD --namespace $NAMESPACE_NAME\"\n      HELM_CMD=\"$HELM_CMD --create-namespace\"\n      HELM_CMD=\"$HELM_CMD --wait\"\n      HELM_CMD=\"$HELM_CMD --timeout 20m\"\n\n      # Neo4j core configuration\n      # Chart automatically selects correct image based on edition\n      HELM_CMD=\"$HELM_CMD --set neo4j.name=$CLUSTER_NAME\"\n      HELM_CMD=\"$HELM_CMD --set neo4j.edition=enterprise\"\n      HELM_CMD=\"$HELM_CMD --set neo4j.acceptLicenseAgreement=$LICENSE_AGREEMENT\"\n      # Password is passed via --set-file to avoid quoting issues with special characters\n      echo -n \"$NEO4J_PASSWORD\" > /tmp/neo4j-password.txt\n      HELM_CMD=\"$HELM_CMD --set-file neo4j.password=/tmp/neo4j-password.txt\"\n\n      # Cluster configuration (only if cluster mode)\n      if [ \"$IS_CLUSTER\" == \"true\" ]; then\n        echo \"Configuring cluster with $NODE_COUNT nodes...\"\n        HELM_CMD=\"$HELM_CMD --set neo4j.minimumClusterSize=$NODE_COUNT\"\n      else\n        echo \"Configuring standalone instance...\"\n      fi\n\n      # Storage configuration\n      # CORRECTED: Use volumes.data.dynamic.requests.storage (not just .storage)\n      HELM_CMD=\"$HELM_CMD --set volumes.data.mode=dynamic\"\n      HELM_CMD=\"$HELM_CMD --set volumes.data.dynamic.storageClassName=$STORAGE_CLASS\"\n      HELM_CMD=\"$HELM_CMD --set volumes.data.dynamic.requests.storage=$STORAGE_SIZE\"\n\n      # Resource configuration\n      # CORRECTED: Use neo4j.resources.cpu and neo4j.resources.memory\n      HELM_CMD=\"$HELM_CMD --set neo4j.resources.cpu=$CPU_REQUEST\"\n      HELM_CMD=\"$HELM_CMD --set neo4j.resources.memory=$MEMORY_REQUEST\"\n\n      # Memory configuration (JVM heap and page cache)\n      # Use --set-string to ensure values are treated as strings, not YAML maps\n      HELM_CMD=\"$HELM_CMD --set-string config.server\\.memory\\.heap\\.initial_size=$HEAP_SIZE\"\n      HELM_CMD=\"$HELM_CMD --set-string config.server\\.memory\\.heap\\.max_size=$HEAP_SIZE\"\n      HELM_CMD=\"$HELM_CMD --set-string config.server\\.memory\\.pagecache\\.size=$PAGECACHE_SIZE\"\n\n      # Plugin configuration (future - currently not used)\n      if [ \"$PLUGINS_ENABLED\" == \"true\" ]; then\n        echo \"Note: Plugin configuration not yet implemented\"\n        # TODO: Implement plugin installation via env.NEO4JLABS_PLUGINS or init containers\n      fi\n\n      # Service configuration (LoadBalancer for Azure external access)\n      HELM_CMD=\"$HELM_CMD --set services.neo4j.enabled=true\"\n      HELM_CMD=\"$HELM_CMD --set services.neo4j.spec.type=LoadBalancer\"\n\n      # Execute Helm install\n      echo \"\"\n      echo \"Executing Helm installation...\"\n      echo \"Command: helm upgrade --install $RELEASE_NAME $HELM_CHART_NAME --version $HELM_CHART_VERSION ...\"\n      echo \"\"\n      eval $HELM_CMD\n\n      # Clean up password file\n      rm -f /tmp/neo4j-password.txt\n\n      # Verify deployment\n      echo \"\"\n      echo \"====================================\"\n      echo \"Verifying Deployment\"\n      echo \"====================================\"\n      kubectl get pods -n $NAMESPACE_NAME\n      echo \"\"\n      kubectl get services -n $NAMESPACE_NAME\n      echo \"\"\n\n      # Wait for LoadBalancer external IP\n      echo \"Waiting for LoadBalancer external IP...\"\n      EXTERNAL_IP=\"\"\n      for i in {1..60}; do\n        EXTERNAL_IP=$(kubectl get service ${RELEASE_NAME} -n $NAMESPACE_NAME -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo \"\")\n        if [ -n \"$EXTERNAL_IP\" ] && [ \"$EXTERNAL_IP\" != \"null\" ]; then\n          echo \"External IP assigned: $EXTERNAL_IP\"\n          break\n        fi\n        echo \"Waiting for external IP... ($i/60)\"\n        sleep 10\n      done\n\n      if [ -z \"$EXTERNAL_IP\" ] || [ \"$EXTERNAL_IP\" == \"null\" ]; then\n        echo \"WARNING: External IP not assigned within timeout\"\n        EXTERNAL_IP=\"pending\"\n      fi\n\n      # Get release status\n      RELEASE_STATUS=$(helm status $RELEASE_NAME -n $NAMESPACE_NAME -o json | jq -r '.info.status')\n      HELM_VERSION=$(helm list -n $NAMESPACE_NAME -o json | jq -r \".[] | select(.name==\\\"$RELEASE_NAME\\\") | .chart\")\n\n      echo \"\"\n      echo \"====================================\"\n      echo \"Deployment Complete!\"\n      echo \"====================================\"\n      echo \"Release: $RELEASE_NAME\"\n      echo \"Status: $RELEASE_STATUS\"\n      echo \"Chart: $HELM_VERSION\"\n      echo \"External IP: $EXTERNAL_IP\"\n      echo \"Neo4j Browser: http://$EXTERNAL_IP:7474\"\n      echo \"Bolt URI: neo4j://$EXTERNAL_IP:7687\"\n      echo \"\"\n      echo \"Note: It may take 2-3 minutes for Neo4j pods to be fully ready.\"\n      echo \"\"\n\n      # Save outputs to JSON for Bicep\n      cat > $AZ_SCRIPTS_OUTPUT_PATH <<EOF\n{\n  \"releaseName\": \"$RELEASE_NAME\",\n  \"releaseStatus\": \"$RELEASE_STATUS\",\n  \"helmVersion\": \"$HELM_VERSION\",\n  \"externalIp\": \"$EXTERNAL_IP\",\n  \"browserUrl\": \"http://$EXTERNAL_IP:7474\",\n  \"boltUri\": \"neo4j://$EXTERNAL_IP:7687\"\n}\nEOF\n\n      echo \"Deployment script completed successfully\"\n    ",
                        "cleanupPreference": "OnSuccess"
                      }
                    }
                  ],
                  "outputs": {
                    "releaseName": {
                      "type": "string",
                      "value": "[parameters('releaseName')]"
                    },
                    "releaseStatus": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('helm-install-{0}', uniqueString(resourceGroup().id, parameters('namespaceName'), parameters('releaseName')))), '2023-08-01').outputs.releaseStatus]"
                    },
                    "helmVersion": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('helm-install-{0}', uniqueString(resourceGroup().id, parameters('namespaceName'), parameters('releaseName')))), '2023-08-01').outputs.helmVersion]"
                    },
                    "externalIp": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('helm-install-{0}', uniqueString(resourceGroup().id, parameters('namespaceName'), parameters('releaseName')))), '2023-08-01').outputs.externalIp]"
                    },
                    "browserUrl": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('helm-install-{0}', uniqueString(resourceGroup().id, parameters('namespaceName'), parameters('releaseName')))), '2023-08-01').outputs.browserUrl]"
                    },
                    "boltUri": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('helm-install-{0}', uniqueString(resourceGroup().id, parameters('namespaceName'), parameters('releaseName')))), '2023-08-01').outputs.boltUri]"
                    },
                    "deploymentStatus": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('helm-install-{0}', uniqueString(resourceGroup().id, parameters('namespaceName'), parameters('releaseName')))), '2023-08-01').provisioningState]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "namespaceName": {
              "type": "string",
              "value": "[parameters('namespaceName')]"
            },
            "serviceAccountName": {
              "type": "string",
              "value": "[parameters('serviceAccountName')]"
            },
            "configMapName": {
              "type": "string",
              "value": "neo4j-config"
            },
            "secretName": {
              "type": "string",
              "value": "neo4j-secrets"
            },
            "statefulSetName": {
              "type": "string",
              "value": "[parameters('statefulSetName')]"
            },
            "serviceName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'helm-deployment'), '2025-04-01').outputs.releaseName.value]"
            },
            "loadBalancerServiceName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'helm-deployment'), '2025-04-01').outputs.releaseName.value]"
            },
            "externalIp": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'helm-deployment'), '2025-04-01').outputs.externalIp.value]"
            },
            "neo4jBrowserUrl": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'helm-deployment'), '2025-04-01').outputs.browserUrl.value]"
            },
            "neo4jBoltUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'helm-deployment'), '2025-04-01').outputs.boltUri.value]"
            }
          }
        }
      },
      "dependsOn": [
        "aksCluster",
        "identity",
        "storage"
      ]
    }
  },
  "outputs": {
    "aksClusterName": {
      "type": "string",
      "value": "[reference('aksCluster').outputs.clusterName.value]"
    },
    "aksClusterId": {
      "type": "string",
      "value": "[reference('aksCluster').outputs.clusterId.value]"
    },
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "oidcIssuerUrl": {
      "type": "string",
      "value": "[reference('aksCluster').outputs.oidcIssuerUrl.value]"
    },
    "managedIdentityClientId": {
      "type": "string",
      "value": "[reference('identity').outputs.clientId.value]"
    },
    "managedIdentityPrincipalId": {
      "type": "string",
      "value": "[reference('identity').outputs.principalId.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[reference('aksCluster').outputs.logAnalyticsWorkspaceId.value]"
    },
    "nodeResourceGroup": {
      "type": "string",
      "value": "[reference('aksCluster').outputs.nodeResourceGroup.value]"
    },
    "neo4jNamespace": {
      "type": "string",
      "value": "[reference('neo4jApp').outputs.namespaceName.value]"
    },
    "neo4jStatefulSet": {
      "type": "string",
      "value": "[reference('neo4jApp').outputs.statefulSetName.value]"
    },
    "neo4jExternalIp": {
      "type": "string",
      "value": "[reference('neo4jApp').outputs.externalIp.value]"
    },
    "neo4jBrowserUrl": {
      "type": "string",
      "value": "[reference('neo4jApp').outputs.neo4jBrowserUrl.value]"
    },
    "neo4jBoltUri": {
      "type": "string",
      "value": "[reference('neo4jApp').outputs.neo4jBoltUri.value]"
    },
    "neo4jUsername": {
      "type": "string",
      "value": "neo4j"
    },
    "neo4jPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Neo4j admin password"
      },
      "value": "[parameters('adminPassword')]"
    },
    "connectionInstructions": {
      "type": "string",
      "value": "# Neo4j on AKS Deployed Successfully!\n\n## Connection Information\nBrowser URL:  ${neo4jApp.outputs.neo4jBrowserUrl}\nBolt URI:     ${neo4jApp.outputs.neo4jBoltUri}\nUsername:     neo4j\nPassword:     (provided during deployment)\n\nDeployment Type: ${deploymentType}\nNeo4j Version:   ${graphDatabaseVersion}\nNode Count:      ${nodeCount}\nLicense Type:    ${licenseType}\n\n## Access Neo4j Browser\nOpen the Browser URL in your web browser and login with the credentials above.\n\nNote: It may take 5-10 minutes for Neo4j pods to be fully ready after deployment.\n\n## Verify Deployment\nGet AKS credentials:\naz aks get-credentials --name ${aksCluster.outputs.clusterName} --resource-group ${resourceGroup().name}\n\nCheck Neo4j pods:\nkubectl get pods -n ${namespacePrefix} -w\n\nView Neo4j logs:\nkubectl logs neo4j-0 -n ${namespacePrefix}\n\nCheck services:\nkubectl get services -n ${namespacePrefix}\n\n## Troubleshooting\nIf you cannot connect:\n1. Wait a few minutes for pods to be ready\n2. Check pod status: kubectl describe pod neo4j-0 -n ${namespacePrefix}\n3. Verify external IP: kubectl get service neo4j-lb -n ${namespacePrefix}\n\n## Cleanup\nTo delete all resources:\n./delete.sh ${resourceGroup().name}\n"
    }
  }
}
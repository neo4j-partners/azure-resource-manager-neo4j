{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "2633507814488979761"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources. Defaults to resource group location."
      }
    },
    "resourceNamePrefix": {
      "type": "string",
      "defaultValue": "neo4j",
      "minLength": 3,
      "maxLength": 10,
      "metadata": {
        "description": "Prefix for all resource names. Used to create unique identifiers."
      }
    },
    "kubernetesVersion": {
      "type": "string",
      "defaultValue": "1.30",
      "metadata": {
        "description": "Kubernetes version for the AKS cluster."
      }
    },
    "systemNodeSize": {
      "type": "string",
      "defaultValue": "Standard_D2s_v5",
      "metadata": {
        "description": "VM size for system node pool (Kubernetes services)."
      }
    },
    "userNodeSize": {
      "type": "string",
      "defaultValue": "Standard_E4s_v5",
      "metadata": {
        "description": "VM size for user node pool (Neo4j workloads)."
      }
    },
    "userNodeCountMin": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 1,
      "maxValue": 10,
      "metadata": {
        "description": "Minimum number of nodes in user node pool."
      }
    },
    "userNodeCountMax": {
      "type": "int",
      "defaultValue": 10,
      "minValue": 1,
      "maxValue": 10,
      "metadata": {
        "description": "Maximum number of nodes in user node pool."
      }
    },
    "nodeCount": {
      "type": "int",
      "defaultValue": 1,
      "allowedValues": [
        1,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10
      ],
      "metadata": {
        "description": "Number of Neo4j instances to deploy (1 for standalone, 3-10 for cluster)."
      }
    },
    "graphDatabaseVersion": {
      "type": "string",
      "defaultValue": "5",
      "allowedValues": [
        "5",
        "4.4"
      ],
      "metadata": {
        "description": "Neo4j graph database version."
      }
    },
    "diskSize": {
      "type": "int",
      "defaultValue": 32,
      "minValue": 32,
      "maxValue": 4096,
      "metadata": {
        "description": "Size of data disk per Neo4j instance in GB."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "minLength": 8,
      "metadata": {
        "description": "Neo4j admin password. Must be at least 8 characters."
      }
    },
    "licenseType": {
      "type": "string",
      "defaultValue": "Evaluation",
      "allowedValues": [
        "Enterprise",
        "Evaluation"
      ],
      "metadata": {
        "description": "Neo4j license type."
      }
    },
    "keyVaultName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional: Name of Key Vault containing Neo4j admin password. Leave empty to use adminPassword parameter."
      }
    },
    "keyVaultResourceGroup": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "Optional: Resource group containing the Key Vault. Defaults to current resource group."
      }
    },
    "adminPasswordSecretName": {
      "type": "string",
      "defaultValue": "neo4j-admin-password",
      "metadata": {
        "description": "Optional: Name of secret in Key Vault containing admin password."
      }
    },
    "installGraphDataScience": {
      "type": "string",
      "defaultValue": "No",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "description": "Install Graph Data Science plugin."
      }
    },
    "graphDataScienceLicenseKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Graph Data Science license key (if installing GDS)."
      }
    },
    "installBloom": {
      "type": "string",
      "defaultValue": "No",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "description": "Install Bloom plugin."
      }
    },
    "bloomLicenseKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Bloom license key (if installing Bloom)."
      }
    }
  },
  "variables": {
    "deploymentUniqueString": "[substring(uniqueString(resourceGroup().id), 0, 6)]",
    "clusterName": "[format('{0}-aks-{1}', parameters('resourceNamePrefix'), variables('deploymentUniqueString'))]",
    "identityName": "[format('{0}-identity-{1}', parameters('resourceNamePrefix'), variables('deploymentUniqueString'))]",
    "namespacePrefix": "neo4j",
    "isCluster": "[greaterOrEquals(parameters('nodeCount'), 3)]",
    "deploymentType": "[if(variables('isCluster'), 'cluster', 'standalone')]",
    "commonTags": {
      "neo4j-version": "[parameters('graphDatabaseVersion')]",
      "neo4j-edition": "enterprise",
      "deployment-type": "aks",
      "deployment-mode": "[variables('deploymentType')]",
      "node-count": "[string(parameters('nodeCount'))]",
      "created-by": "neo4j-azure-marketplace",
      "managed-by": "bicep"
    },
    "initialUserNodeCount": "[parameters('nodeCount')]"
  },
  "resources": {
    "network": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceNamePrefix": {
            "value": "[parameters('resourceNamePrefix')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6575308329173336084"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "resourceNamePrefix": {
              "type": "string",
              "metadata": {
                "description": "Prefix for resource names"
              }
            },
            "vnetAddressSpace": {
              "type": "string",
              "defaultValue": "10.0.0.0/8",
              "metadata": {
                "description": "Address space for virtual network"
              }
            },
            "systemSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.0.0.0/16",
              "metadata": {
                "description": "Address prefix for system node pool subnet"
              }
            },
            "userSubnetPrefix": {
              "type": "string",
              "defaultValue": "10.1.0.0/16",
              "metadata": {
                "description": "Address prefix for user node pool subnet"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}-vnet', parameters('resourceNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressSpace')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "system-subnet",
                    "properties": {
                      "addressPrefix": "[parameters('systemSubnetPrefix')]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "user-subnet",
                    "properties": {
                      "addressPrefix": "[parameters('userSubnetPrefix')]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg', parameters('resourceNamePrefix')))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled",
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage"
                        },
                        {
                          "service": "Microsoft.KeyVault"
                        }
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg', parameters('resourceNamePrefix')))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}-nsg', parameters('resourceNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowNeo4jBolt",
                    "properties": {
                      "description": "Allow Neo4j Bolt protocol (client connections)",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7687",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowNeo4jHTTP",
                    "properties": {
                      "description": "Allow Neo4j Browser HTTP",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7474",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 101,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowNeo4jHTTPS",
                    "properties": {
                      "description": "Allow Neo4j Browser HTTPS",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7473",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 102,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowNeo4jClusterTransaction",
                    "properties": {
                      "description": "Allow Neo4j cluster transaction shipping",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "6000",
                      "sourceAddressPrefix": "[parameters('userSubnetPrefix')]",
                      "destinationAddressPrefix": "[parameters('userSubnetPrefix')]",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowNeo4jClusterRaft",
                    "properties": {
                      "description": "Allow Neo4j cluster Raft consensus",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7000",
                      "sourceAddressPrefix": "[parameters('userSubnetPrefix')]",
                      "destinationAddressPrefix": "[parameters('userSubnetPrefix')]",
                      "access": "Allow",
                      "priority": 111,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowAzureLoadBalancerInbound",
                    "properties": {
                      "description": "Allow Azure Load Balancer health probes",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "description": "Deny all other inbound traffic",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 4096,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowAllOutbound",
                    "properties": {
                      "description": "Allow all outbound traffic (Azure services accessed via service endpoints)",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', format('{0}-vnet', parameters('resourceNamePrefix')))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[format('{0}-vnet', parameters('resourceNamePrefix'))]"
            },
            "systemSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', format('{0}-vnet', parameters('resourceNamePrefix'))), '2023-11-01').subnets[0].id]"
            },
            "systemSubnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', format('{0}-vnet', parameters('resourceNamePrefix'))), '2023-11-01').subnets[0].name]"
            },
            "userSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', format('{0}-vnet', parameters('resourceNamePrefix'))), '2023-11-01').subnets[1].id]"
            },
            "userSubnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', format('{0}-vnet', parameters('resourceNamePrefix'))), '2023-11-01').subnets[1].name]"
            },
            "nsgId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg', parameters('resourceNamePrefix')))]"
            },
            "nsgName": {
              "type": "string",
              "value": "[format('{0}-nsg', parameters('resourceNamePrefix'))]"
            }
          }
        }
      }
    },
    "identity": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "identity-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "identityName": {
            "value": "[variables('identityName')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8066549291953551079"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "Name for the managed identity"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-07-31-preview",
              "name": "[parameters('identityName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "identityId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
            },
            "identityName": {
              "type": "string",
              "value": "[parameters('identityName')]"
            },
            "clientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-07-31-preview').clientId]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-07-31-preview').principalId]"
            }
          }
        }
      }
    },
    "aksCluster": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "aks-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "clusterName": {
            "value": "[variables('clusterName')]"
          },
          "kubernetesVersion": {
            "value": "[parameters('kubernetesVersion')]"
          },
          "systemSubnetId": {
            "value": "[reference('network').outputs.systemSubnetId.value]"
          },
          "userSubnetId": {
            "value": "[reference('network').outputs.userSubnetId.value]"
          },
          "identityId": {
            "value": "[reference('identity').outputs.identityId.value]"
          },
          "identityPrincipalId": {
            "value": "[reference('identity').outputs.principalId.value]"
          },
          "systemNodeSize": {
            "value": "[parameters('systemNodeSize')]"
          },
          "userNodeSize": {
            "value": "[parameters('userNodeSize')]"
          },
          "userNodeCountMin": {
            "value": "[parameters('userNodeCountMin')]"
          },
          "userNodeCountMax": {
            "value": "[parameters('userNodeCountMax')]"
          },
          "userNodeCount": {
            "value": "[variables('initialUserNodeCount')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6753351069026095343"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for all resources"
              }
            },
            "clusterName": {
              "type": "string",
              "metadata": {
                "description": "Name for the AKS cluster"
              }
            },
            "kubernetesVersion": {
              "type": "string",
              "defaultValue": "1.31",
              "metadata": {
                "description": "Kubernetes version"
              }
            },
            "systemSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the system subnet"
              }
            },
            "userSubnetId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the user subnet"
              }
            },
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the managed identity"
              }
            },
            "identityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the managed identity"
              }
            },
            "systemNodeSize": {
              "type": "string",
              "defaultValue": "Standard_D2s_v5",
              "metadata": {
                "description": "VM size for system node pool"
              }
            },
            "userNodeSize": {
              "type": "string",
              "defaultValue": "Standard_E4s_v5",
              "metadata": {
                "description": "VM size for user node pool"
              }
            },
            "userNodeCountMin": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Minimum node count for user node pool"
              }
            },
            "userNodeCountMax": {
              "type": "int",
              "defaultValue": 10,
              "metadata": {
                "description": "Maximum node count for user node pool"
              }
            },
            "userNodeCount": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Initial node count for user node pool"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            }
          },
          "variables": {
            "aksClusterUserRoleId": "4abbcc35-e782-43d8-92c5-2d3f1bd2253f"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}-logs', parameters('clusterName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              }
            },
            {
              "type": "Microsoft.ContainerService/managedClusters",
              "apiVersion": "2024-02-01",
              "name": "[parameters('clusterName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identityId'))]": {}
                }
              },
              "properties": {
                "kubernetesVersion": "[parameters('kubernetesVersion')]",
                "dnsPrefix": "[format('{0}-dns', parameters('clusterName'))]",
                "oidcIssuerProfile": {
                  "enabled": true
                },
                "securityProfile": {
                  "workloadIdentity": {
                    "enabled": true
                  }
                },
                "agentPoolProfiles": [
                  {
                    "name": "system",
                    "count": 3,
                    "vmSize": "[parameters('systemNodeSize')]",
                    "osType": "Linux",
                    "osSKU": "AzureLinux",
                    "mode": "System",
                    "vnetSubnetID": "[parameters('systemSubnetId')]",
                    "enableAutoScaling": false,
                    "type": "VirtualMachineScaleSets",
                    "nodeTaints": [
                      "CriticalAddonsOnly=true:NoSchedule"
                    ],
                    "nodeLabels": {
                      "nodepool-type": "system"
                    }
                  },
                  {
                    "name": "user",
                    "count": "[parameters('userNodeCount')]",
                    "minCount": "[parameters('userNodeCountMin')]",
                    "maxCount": "[parameters('userNodeCountMax')]",
                    "vmSize": "[parameters('userNodeSize')]",
                    "osType": "Linux",
                    "osSKU": "AzureLinux",
                    "mode": "User",
                    "vnetSubnetID": "[parameters('userSubnetId')]",
                    "enableAutoScaling": true,
                    "type": "VirtualMachineScaleSets",
                    "nodeLabels": {
                      "nodepool-type": "user",
                      "workload": "neo4j"
                    },
                    "tags": {
                      "workload": "neo4j"
                    }
                  }
                ],
                "networkProfile": {
                  "networkPlugin": "azure",
                  "networkPolicy": "azure",
                  "loadBalancerSku": "standard",
                  "outboundType": "loadBalancer",
                  "serviceCidr": "172.16.0.0/16",
                  "dnsServiceIP": "172.16.0.10"
                },
                "addonProfiles": {
                  "omsagent": {
                    "enabled": true,
                    "config": {
                      "logAnalyticsWorkspaceResourceID": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('clusterName')))]"
                    }
                  },
                  "azurePolicy": {
                    "enabled": true
                  }
                },
                "autoUpgradeProfile": {
                  "upgradeChannel": "stable"
                },
                "disableLocalAccounts": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('clusterName')))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.ContainerService/managedClusters/{0}', parameters('clusterName'))]",
              "name": "[format('{0}-diagnostics', parameters('clusterName'))]",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('clusterName')))]",
                "logs": [
                  {
                    "category": "kube-apiserver",
                    "enabled": true
                  },
                  {
                    "category": "kube-controller-manager",
                    "enabled": true
                  },
                  {
                    "category": "kube-scheduler",
                    "enabled": true
                  },
                  {
                    "category": "kube-audit",
                    "enabled": true
                  },
                  {
                    "category": "cluster-autoscaler",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName'))]",
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('clusterName')))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerService/managedClusters/{0}', parameters('clusterName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName')), parameters('identityPrincipalId'), 'aks-cluster-user')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('aksClusterUserRoleId'))]",
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName'))]"
              ]
            }
          ],
          "outputs": {
            "clusterId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName'))]"
            },
            "clusterName": {
              "type": "string",
              "value": "[parameters('clusterName')]"
            },
            "oidcIssuerUrl": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName')), '2024-02-01').oidcIssuerProfile.issuerURL]"
            },
            "kubeletIdentityObjectId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName')), '2024-02-01').identityProfile.kubeletidentity.objectId]"
            },
            "nodeResourceGroup": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName')), '2024-02-01').nodeResourceGroup]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs', parameters('clusterName')))]"
            },
            "fqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName')), '2024-02-01').fqdn]"
            }
          }
        }
      },
      "dependsOn": [
        "identity",
        "network"
      ]
    },
    "storage": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "aksClusterName": {
            "value": "[reference('aksCluster').outputs.clusterName.value]"
          },
          "aksResourceGroup": {
            "value": "[resourceGroup().name]"
          },
          "storageClassName": {
            "value": "neo4j-premium"
          },
          "identityId": {
            "value": "[reference('identity').outputs.identityId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3202734491184374820"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for deployment scripts"
              }
            },
            "aksClusterName": {
              "type": "string",
              "metadata": {
                "description": "Name of the AKS cluster"
              }
            },
            "aksResourceGroup": {
              "type": "string",
              "metadata": {
                "description": "Resource group containing the AKS cluster"
              }
            },
            "storageClassName": {
              "type": "string",
              "defaultValue": "neo4j-premium",
              "metadata": {
                "description": "Name for the StorageClass"
              }
            },
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "Managed identity for deployment script"
              }
            }
          },
          "variables": {
            "storageClassYaml": "[format('apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: {0}\nprovisioner: disk.csi.azure.com\nparameters:\n  skuName: Premium_LRS\n  kind: Managed\n  cachingMode: ReadOnly\nreclaimPolicy: Retain\nallowVolumeExpansion: true\nvolumeBindingMode: WaitForFirstConsumer\n', parameters('storageClassName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "[format('create-storageclass-{0}', uniqueString(resourceGroup().id))]",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identityId'))]": {}
                }
              },
              "properties": {
                "azCliVersion": "2.50.0",
                "timeout": "PT10M",
                "retentionInterval": "PT1H",
                "environmentVariables": [
                  {
                    "name": "AKS_CLUSTER_NAME",
                    "value": "[parameters('aksClusterName')]"
                  },
                  {
                    "name": "AKS_RESOURCE_GROUP",
                    "value": "[parameters('aksResourceGroup')]"
                  },
                  {
                    "name": "STORAGE_CLASS_YAML",
                    "value": "[variables('storageClassYaml')]"
                  }
                ],
                "scriptContent": "      #!/bin/bash\n      set -e\n\n      echo \"Installing kubectl...\"\n      az aks install-cli\n\n      echo \"Getting AKS credentials...\"\n      az aks get-credentials --name $AKS_CLUSTER_NAME --resource-group $AKS_RESOURCE_GROUP --overwrite-existing\n\n      echo \"Creating StorageClass...\"\n      echo \"$STORAGE_CLASS_YAML\" | kubectl apply -f -\n\n      echo \"Verifying StorageClass...\"\n      kubectl get storageclass ${storageClassName}\n\n      echo \"StorageClass created successfully\"\n    ",
                "cleanupPreference": "OnSuccess"
              }
            }
          ],
          "outputs": {
            "storageClassName": {
              "type": "string",
              "value": "[parameters('storageClassName')]"
            },
            "deploymentStatus": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('create-storageclass-{0}', uniqueString(resourceGroup().id))), '2023-08-01').provisioningState]"
            }
          }
        }
      },
      "dependsOn": [
        "aksCluster",
        "identity"
      ]
    },
    "neo4jApp": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "neo4j-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "aksClusterName": {
            "value": "[reference('aksCluster').outputs.clusterName.value]"
          },
          "aksResourceGroup": {
            "value": "[resourceGroup().name]"
          },
          "identityId": {
            "value": "[reference('identity').outputs.identityId.value]"
          },
          "managedIdentityClientId": {
            "value": "[reference('identity').outputs.clientId.value]"
          },
          "namespaceName": {
            "value": "[variables('namespacePrefix')]"
          },
          "serviceAccountName": {
            "value": "neo4j-sa"
          },
          "statefulSetName": {
            "value": "neo4j"
          },
          "serviceName": {
            "value": "neo4j"
          },
          "loadBalancerServiceName": {
            "value": "neo4j-lb"
          },
          "dnsLabelPrefix": {
            "value": "[format('{0}-{1}', parameters('resourceNamePrefix'), variables('deploymentUniqueString'))]"
          },
          "replicas": {
            "value": "[parameters('nodeCount')]"
          },
          "graphDatabaseVersion": {
            "value": "[parameters('graphDatabaseVersion')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "licenseType": {
            "value": "[parameters('licenseType')]"
          },
          "diskSize": {
            "value": "[parameters('diskSize')]"
          },
          "storageClassName": {
            "value": "neo4j-premium"
          },
          "installGraphDataScience": {
            "value": "[equals(parameters('installGraphDataScience'), 'Yes')]"
          },
          "installBloom": {
            "value": "[equals(parameters('installBloom'), 'Yes')]"
          },
          "cpuLimit": {
            "value": "4"
          },
          "memoryLimit": {
            "value": "16Gi"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8858434472508627736"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for deployment scripts"
              }
            },
            "aksClusterName": {
              "type": "string",
              "metadata": {
                "description": "Name of the AKS cluster"
              }
            },
            "aksResourceGroup": {
              "type": "string",
              "metadata": {
                "description": "Resource group containing the AKS cluster"
              }
            },
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "Managed identity ID for deployment scripts"
              }
            },
            "managedIdentityClientId": {
              "type": "string",
              "metadata": {
                "description": "Managed identity client ID for Workload Identity"
              }
            },
            "namespaceName": {
              "type": "string",
              "defaultValue": "neo4j",
              "metadata": {
                "description": "Kubernetes namespace name"
              }
            },
            "serviceAccountName": {
              "type": "string",
              "defaultValue": "neo4j-sa",
              "metadata": {
                "description": "Service account name"
              }
            },
            "statefulSetName": {
              "type": "string",
              "defaultValue": "neo4j",
              "metadata": {
                "description": "StatefulSet name"
              }
            },
            "serviceName": {
              "type": "string",
              "defaultValue": "neo4j",
              "metadata": {
                "description": "Service name"
              }
            },
            "loadBalancerServiceName": {
              "type": "string",
              "defaultValue": "neo4j-lb",
              "metadata": {
                "description": "LoadBalancer service name"
              }
            },
            "dnsLabelPrefix": {
              "type": "string",
              "metadata": {
                "description": "DNS label prefix for LoadBalancer"
              }
            },
            "replicas": {
              "type": "int",
              "metadata": {
                "description": "Number of Neo4j replicas"
              }
            },
            "graphDatabaseVersion": {
              "type": "string",
              "metadata": {
                "description": "Neo4j graph database version"
              }
            },
            "adminPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Neo4j admin password"
              }
            },
            "licenseType": {
              "type": "string",
              "allowedValues": [
                "Enterprise",
                "Evaluation"
              ],
              "metadata": {
                "description": "Neo4j license type"
              }
            },
            "diskSize": {
              "type": "int",
              "metadata": {
                "description": "Size of data disk per pod in GB"
              }
            },
            "storageClassName": {
              "type": "string",
              "metadata": {
                "description": "Storage class name"
              }
            },
            "installGraphDataScience": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Install Graph Data Science plugin"
              }
            },
            "installBloom": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Install Bloom plugin"
              }
            },
            "cpuLimit": {
              "type": "string",
              "defaultValue": "4",
              "metadata": {
                "description": "CPU limit per pod"
              }
            },
            "memoryLimit": {
              "type": "string",
              "defaultValue": "16Gi",
              "metadata": {
                "description": "Memory limit per pod"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "namespace-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "aksResourceGroup": {
                    "value": "[parameters('aksResourceGroup')]"
                  },
                  "namespaceName": {
                    "value": "[parameters('namespaceName')]"
                  },
                  "identityId": {
                    "value": "[parameters('identityId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "12306353730769916109"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for deployment scripts"
                      }
                    },
                    "aksClusterName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the AKS cluster"
                      }
                    },
                    "aksResourceGroup": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource group containing the AKS cluster"
                      }
                    },
                    "namespaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name for the Kubernetes namespace"
                      }
                    },
                    "identityId": {
                      "type": "string",
                      "metadata": {
                        "description": "Managed identity for deployment script"
                      }
                    }
                  },
                  "variables": {
                    "namespaceYaml": "[format('apiVersion: v1\nkind: Namespace\nmetadata:\n  name: {0}\n  labels:\n    app: neo4j\n    managed-by: bicep\n', parameters('namespaceName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[format('create-namespace-{0}', uniqueString(resourceGroup().id, parameters('namespaceName')))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('identityId'))]": {}
                        }
                      },
                      "properties": {
                        "azCliVersion": "2.50.0",
                        "timeout": "PT5M",
                        "retentionInterval": "PT1H",
                        "environmentVariables": [
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "AKS_RESOURCE_GROUP",
                            "value": "[parameters('aksResourceGroup')]"
                          },
                          {
                            "name": "NAMESPACE_YAML",
                            "value": "[variables('namespaceYaml')]"
                          }
                        ],
                        "scriptContent": "      #!/bin/bash\n      set -e\n\n      echo \"Installing kubectl...\"\n      az aks install-cli\n\n      echo \"Getting AKS credentials...\"\n      az aks get-credentials --name $AKS_CLUSTER_NAME --resource-group $AKS_RESOURCE_GROUP --overwrite-existing\n\n      echo \"Creating namespace...\"\n      echo \"$NAMESPACE_YAML\" | kubectl apply -f -\n\n      echo \"Verifying namespace...\"\n      kubectl get namespace ${namespaceName}\n\n      echo \"Namespace created successfully\"\n    ",
                        "cleanupPreference": "OnSuccess"
                      }
                    }
                  ],
                  "outputs": {
                    "namespaceName": {
                      "type": "string",
                      "value": "[parameters('namespaceName')]"
                    },
                    "deploymentStatus": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('create-namespace-{0}', uniqueString(resourceGroup().id, parameters('namespaceName')))), '2023-08-01').provisioningState]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "serviceaccount-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "aksResourceGroup": {
                    "value": "[parameters('aksResourceGroup')]"
                  },
                  "namespaceName": {
                    "value": "[parameters('namespaceName')]"
                  },
                  "serviceAccountName": {
                    "value": "[parameters('serviceAccountName')]"
                  },
                  "managedIdentityClientId": {
                    "value": "[parameters('managedIdentityClientId')]"
                  },
                  "identityId": {
                    "value": "[parameters('identityId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "7286511812602167143"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for deployment scripts"
                      }
                    },
                    "aksClusterName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the AKS cluster"
                      }
                    },
                    "aksResourceGroup": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource group containing the AKS cluster"
                      }
                    },
                    "namespaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Kubernetes namespace for the service account"
                      }
                    },
                    "serviceAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name for the service account"
                      }
                    },
                    "managedIdentityClientId": {
                      "type": "string",
                      "metadata": {
                        "description": "Client ID of the managed identity for Workload Identity"
                      }
                    },
                    "tenantId": {
                      "type": "string",
                      "defaultValue": "[subscription().tenantId]",
                      "metadata": {
                        "description": "Azure tenant ID"
                      }
                    },
                    "identityId": {
                      "type": "string",
                      "metadata": {
                        "description": "Managed identity for deployment script"
                      }
                    }
                  },
                  "variables": {
                    "serviceAccountYaml": "[format('apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: {0}\n  namespace: {1}\n  annotations:\n    azure.workload.identity/client-id: \"{2}\"\n    azure.workload.identity/tenant-id: \"{3}\"\n  labels:\n    azure.workload.identity/use: \"true\"\n    app: neo4j\n    managed-by: bicep\n', parameters('serviceAccountName'), parameters('namespaceName'), parameters('managedIdentityClientId'), parameters('tenantId'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[format('create-serviceaccount-{0}', uniqueString(resourceGroup().id, parameters('namespaceName')))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('identityId'))]": {}
                        }
                      },
                      "properties": {
                        "azCliVersion": "2.50.0",
                        "timeout": "PT5M",
                        "retentionInterval": "PT1H",
                        "environmentVariables": [
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "AKS_RESOURCE_GROUP",
                            "value": "[parameters('aksResourceGroup')]"
                          },
                          {
                            "name": "SERVICE_ACCOUNT_YAML",
                            "value": "[variables('serviceAccountYaml')]"
                          }
                        ],
                        "scriptContent": "      #!/bin/bash\n      set -e\n\n      echo \"Installing kubectl...\"\n      az aks install-cli\n\n      echo \"Getting AKS credentials...\"\n      az aks get-credentials --name $AKS_CLUSTER_NAME --resource-group $AKS_RESOURCE_GROUP --overwrite-existing\n\n      echo \"Creating service account...\"\n      echo \"$SERVICE_ACCOUNT_YAML\" | kubectl apply -f -\n\n      echo \"Verifying service account...\"\n      kubectl get serviceaccount ${serviceAccountName} -n ${namespaceName}\n\n      echo \"Service account created successfully\"\n    ",
                        "cleanupPreference": "OnSuccess"
                      }
                    }
                  ],
                  "outputs": {
                    "serviceAccountName": {
                      "type": "string",
                      "value": "[parameters('serviceAccountName')]"
                    },
                    "deploymentStatus": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('create-serviceaccount-{0}', uniqueString(resourceGroup().id, parameters('namespaceName')))), '2023-08-01').provisioningState]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'namespace-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "configuration-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "aksResourceGroup": {
                    "value": "[parameters('aksResourceGroup')]"
                  },
                  "namespaceName": {
                    "value": "[parameters('namespaceName')]"
                  },
                  "graphDatabaseVersion": {
                    "value": "[parameters('graphDatabaseVersion')]"
                  },
                  "adminPassword": {
                    "value": "[parameters('adminPassword')]"
                  },
                  "licenseType": {
                    "value": "[parameters('licenseType')]"
                  },
                  "nodeCount": {
                    "value": "[parameters('replicas')]"
                  },
                  "serviceName": {
                    "value": "[parameters('serviceName')]"
                  },
                  "installGraphDataScience": {
                    "value": "[parameters('installGraphDataScience')]"
                  },
                  "installBloom": {
                    "value": "[parameters('installBloom')]"
                  },
                  "identityId": {
                    "value": "[parameters('identityId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "16288342732609841218"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for deployment scripts"
                      }
                    },
                    "aksClusterName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the AKS cluster"
                      }
                    },
                    "aksResourceGroup": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource group containing the AKS cluster"
                      }
                    },
                    "namespaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Kubernetes namespace"
                      }
                    },
                    "graphDatabaseVersion": {
                      "type": "string",
                      "metadata": {
                        "description": "Neo4j graph database version"
                      }
                    },
                    "adminPassword": {
                      "type": "securestring",
                      "metadata": {
                        "description": "Neo4j admin password"
                      }
                    },
                    "licenseType": {
                      "type": "string",
                      "allowedValues": [
                        "Enterprise",
                        "Evaluation"
                      ],
                      "metadata": {
                        "description": "Neo4j license type"
                      }
                    },
                    "nodeCount": {
                      "type": "int",
                      "metadata": {
                        "description": "Number of Neo4j nodes (1 for standalone, 3+ for cluster)"
                      }
                    },
                    "serviceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Service name for Neo4j (used for DNS)"
                      }
                    },
                    "installGraphDataScience": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Install Graph Data Science plugin"
                      }
                    },
                    "installBloom": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Install Bloom plugin"
                      }
                    },
                    "identityId": {
                      "type": "string",
                      "metadata": {
                        "description": "Managed identity for deployment script"
                      }
                    }
                  },
                  "variables": {
                    "copy": [
                      {
                        "name": "discoveryEndpointsList",
                        "count": "[length(range(0, parameters('nodeCount')))]",
                        "input": "[format('{0}-{1}.{2}.{3}.svc.cluster.local:6000', parameters('serviceName'), range(0, parameters('nodeCount'))[copyIndex('discoveryEndpointsList')], parameters('serviceName'), parameters('namespaceName'))]"
                      }
                    ],
                    "isCluster": "[greaterOrEquals(parameters('nodeCount'), 3)]",
                    "licenseAgreement": "[if(equals(parameters('licenseType'), 'Evaluation'), 'eval', 'yes')]",
                    "discoveryEndpoints": "[if(variables('isCluster'), join(variables('discoveryEndpointsList'), ','), '')]",
                    "baseConfig": "[format('apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: neo4j-config\n  namespace: {0}\ndata:\n  NEO4J_EDITION: \"enterprise\"\n  NEO4J_ACCEPT_LICENSE_AGREEMENT: \"{1}\"\n  NEO4J_server_default__listen__address: \"0.0.0.0\"\n  NEO4J_server_bolt_advertised__address: \":7687\"\n  NEO4J_server_http_advertised__address: \":7474\"\n  NEO4J_server_https_advertised__address: \":7473\"\n  NEO4J_dbms_security_auth__enabled: \"true\"\n  NEO4J_server_directories_data: \"/data\"\n  NEO4J_server_directories_logs: \"/logs\"\n  NEO4J_server_memory_heap_initial__size: \"2G\"\n  NEO4J_server_memory_heap_max__size: \"2G\"\n  NEO4J_server_memory_pagecache_size: \"4G\"\n  NEO4J_dbms_default__database: \"neo4j\"\n', parameters('namespaceName'), variables('licenseAgreement'))]",
                    "clusterConfig": "[format('  NEO4J_server_cluster_system__database__mode: \"PRIMARY\"\n  NEO4J_server_discovery_v2_endpoints: \"{0}\"\n  NEO4J_initial_server_mode__constraint: \"PRIMARY\"\n', variables('discoveryEndpoints'))]",
                    "configMapYaml": "[if(variables('isCluster'), format('{0}{1}', variables('baseConfig'), variables('clusterConfig')), variables('baseConfig'))]",
                    "secretYaml": "[format('apiVersion: v1\nkind: Secret\nmetadata:\n  name: neo4j-auth\n  namespace: {0}\ntype: Opaque\nstringData:\n  NEO4J_AUTH: \"neo4j/{1}\"\n', parameters('namespaceName'), parameters('adminPassword'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[format('create-config-{0}', uniqueString(resourceGroup().id, parameters('namespaceName')))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('identityId'))]": {}
                        }
                      },
                      "properties": {
                        "azCliVersion": "2.50.0",
                        "timeout": "PT5M",
                        "retentionInterval": "PT1H",
                        "environmentVariables": [
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "AKS_RESOURCE_GROUP",
                            "value": "[parameters('aksResourceGroup')]"
                          },
                          {
                            "name": "CONFIGMAP_YAML",
                            "value": "[variables('configMapYaml')]"
                          },
                          {
                            "name": "SECRET_YAML",
                            "value": "[variables('secretYaml')]"
                          }
                        ],
                        "scriptContent": "      #!/bin/bash\n      set -e\n\n      echo \"Installing kubectl...\"\n      az aks install-cli\n\n      echo \"Getting AKS credentials...\"\n      az aks get-credentials --name $AKS_CLUSTER_NAME --resource-group $AKS_RESOURCE_GROUP --overwrite-existing\n\n      echo \"Creating ConfigMap...\"\n      echo \"$CONFIGMAP_YAML\" | kubectl apply -f -\n\n      echo \"Creating Secret...\"\n      echo \"$SECRET_YAML\" | kubectl apply -f -\n\n      echo \"Verifying resources...\"\n      kubectl get configmap neo4j-config -n ${namespaceName}\n      kubectl get secret neo4j-auth -n ${namespaceName}\n\n      echo \"Configuration created successfully\"\n    ",
                        "cleanupPreference": "OnSuccess"
                      }
                    }
                  ],
                  "outputs": {
                    "configMapName": {
                      "type": "string",
                      "value": "neo4j-config"
                    },
                    "secretName": {
                      "type": "string",
                      "value": "neo4j-auth"
                    },
                    "deploymentStatus": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('create-config-{0}', uniqueString(resourceGroup().id, parameters('namespaceName')))), '2023-08-01').provisioningState]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'namespace-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "statefulset-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "aksResourceGroup": {
                    "value": "[parameters('aksResourceGroup')]"
                  },
                  "namespaceName": {
                    "value": "[parameters('namespaceName')]"
                  },
                  "statefulSetName": {
                    "value": "[parameters('statefulSetName')]"
                  },
                  "serviceName": {
                    "value": "[parameters('serviceName')]"
                  },
                  "serviceAccountName": {
                    "value": "[parameters('serviceAccountName')]"
                  },
                  "replicas": {
                    "value": "[parameters('replicas')]"
                  },
                  "graphDatabaseVersion": {
                    "value": "[parameters('graphDatabaseVersion')]"
                  },
                  "diskSize": {
                    "value": "[parameters('diskSize')]"
                  },
                  "storageClassName": {
                    "value": "[parameters('storageClassName')]"
                  },
                  "cpuLimit": {
                    "value": "[parameters('cpuLimit')]"
                  },
                  "memoryLimit": {
                    "value": "[parameters('memoryLimit')]"
                  },
                  "identityId": {
                    "value": "[parameters('identityId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "4204103926449170705"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for deployment scripts"
                      }
                    },
                    "aksClusterName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the AKS cluster"
                      }
                    },
                    "aksResourceGroup": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource group containing the AKS cluster"
                      }
                    },
                    "namespaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Kubernetes namespace"
                      }
                    },
                    "statefulSetName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name for the StatefulSet"
                      }
                    },
                    "serviceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Service name for headless service"
                      }
                    },
                    "serviceAccountName": {
                      "type": "string",
                      "metadata": {
                        "description": "Service account name"
                      }
                    },
                    "replicas": {
                      "type": "int",
                      "metadata": {
                        "description": "Number of Neo4j replicas"
                      }
                    },
                    "graphDatabaseVersion": {
                      "type": "string",
                      "metadata": {
                        "description": "Neo4j graph database version"
                      }
                    },
                    "diskSize": {
                      "type": "int",
                      "metadata": {
                        "description": "Size of data disk per pod in GB"
                      }
                    },
                    "storageClassName": {
                      "type": "string",
                      "metadata": {
                        "description": "Storage class name"
                      }
                    },
                    "cpuLimit": {
                      "type": "string",
                      "defaultValue": "4",
                      "metadata": {
                        "description": "CPU request and limit"
                      }
                    },
                    "memoryLimit": {
                      "type": "string",
                      "defaultValue": "16Gi",
                      "metadata": {
                        "description": "Memory request and limit"
                      }
                    },
                    "identityId": {
                      "type": "string",
                      "metadata": {
                        "description": "Managed identity for deployment script"
                      }
                    }
                  },
                  "variables": {
                    "neo4jImage": "[if(equals(parameters('graphDatabaseVersion'), '5'), 'neo4j:5-enterprise', 'neo4j:4.4-enterprise')]",
                    "statefulSetYaml": "[format('apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: {0}\n  namespace: {1}\n  labels:\n    app: neo4j\n    component: core\nspec:\n  serviceName: {2}\n  replicas: {3}\n  selector:\n    matchLabels:\n      app: neo4j\n      component: core\n  template:\n    metadata:\n      labels:\n        app: neo4j\n        component: core\n        azure.workload.identity/use: \"true\"\n    spec:\n      serviceAccountName: {4}\n      securityContext:\n        fsGroup: 7474\n        runAsUser: 7474\n        runAsGroup: 7474\n        runAsNonRoot: true\n      initContainers:\n      - name: init-data-dir\n        image: busybox:latest\n        command:\n        - sh\n        - -c\n        - |\n          echo \"Initializing data directory...\"\n          mkdir -p /data /logs\n          chown -R 7474:7474 /data /logs\n          chmod 755 /data /logs\n          echo \"Data directory initialized\"\n        volumeMounts:\n        - name: data\n          mountPath: /data\n        - name: logs\n          mountPath: /logs\n        securityContext:\n          runAsUser: 0\n      containers:\n      - name: neo4j\n        image: {5}\n        imagePullPolicy: IfNotPresent\n        ports:\n        - containerPort: 7474\n          name: http\n        - containerPort: 7473\n          name: https\n        - containerPort: 7687\n          name: bolt\n        - containerPort: 6000\n          name: cluster-tx\n        - containerPort: 7000\n          name: cluster-raft\n        env:\n        - name: POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        - name: POD_NAMESPACE\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.namespace\n        envFrom:\n        - configMapRef:\n            name: neo4j-config\n        - secretRef:\n            name: neo4j-auth\n        volumeMounts:\n        - name: data\n          mountPath: /data\n        - name: logs\n          mountPath: /logs\n        resources:\n          requests:\n            cpu: \"{6}\"\n            memory: \"{7}\"\n          limits:\n            cpu: \"{8}\"\n            memory: \"{9}\"\n        livenessProbe:\n          httpGet:\n            path: /\n            port: 7474\n          initialDelaySeconds: 300\n          periodSeconds: 10\n          timeoutSeconds: 5\n          failureThreshold: 3\n        readinessProbe:\n          tcpSocket:\n            port: 7687\n          initialDelaySeconds: 30\n          periodSeconds: 10\n          timeoutSeconds: 5\n          failureThreshold: 3\n      volumes:\n      - name: logs\n        emptyDir: {{}}\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      storageClassName: {10}\n      resources:\n        requests:\n          storage: {11}Gi\n', parameters('statefulSetName'), parameters('namespaceName'), parameters('serviceName'), parameters('replicas'), parameters('serviceAccountName'), variables('neo4jImage'), parameters('cpuLimit'), parameters('memoryLimit'), parameters('cpuLimit'), parameters('memoryLimit'), parameters('storageClassName'), parameters('diskSize'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[format('create-statefulset-{0}', uniqueString(resourceGroup().id, parameters('namespaceName')))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('identityId'))]": {}
                        }
                      },
                      "properties": {
                        "azCliVersion": "2.50.0",
                        "timeout": "PT10M",
                        "retentionInterval": "PT1H",
                        "environmentVariables": [
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "AKS_RESOURCE_GROUP",
                            "value": "[parameters('aksResourceGroup')]"
                          },
                          {
                            "name": "STATEFULSET_YAML",
                            "value": "[variables('statefulSetYaml')]"
                          }
                        ],
                        "scriptContent": "      #!/bin/bash\n      set -e\n\n      echo \"Installing kubectl...\"\n      az aks install-cli\n\n      echo \"Getting AKS credentials...\"\n      az aks get-credentials --name $AKS_CLUSTER_NAME --resource-group $AKS_RESOURCE_GROUP --overwrite-existing\n\n      echo \"Creating StatefulSet...\"\n      echo \"$STATEFULSET_YAML\" | kubectl apply -f -\n\n      echo \"Verifying StatefulSet...\"\n      kubectl get statefulset ${statefulSetName} -n ${namespaceName}\n\n      echo \"StatefulSet created successfully\"\n    ",
                        "cleanupPreference": "OnSuccess"
                      }
                    }
                  ],
                  "outputs": {
                    "statefulSetName": {
                      "type": "string",
                      "value": "[parameters('statefulSetName')]"
                    },
                    "deploymentStatus": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('create-statefulset-{0}', uniqueString(resourceGroup().id, parameters('namespaceName')))), '2023-08-01').provisioningState]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'configuration-deployment')]",
                "[resourceId('Microsoft.Resources/deployments', 'serviceaccount-deployment')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "services-deployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "aksClusterName": {
                    "value": "[parameters('aksClusterName')]"
                  },
                  "aksResourceGroup": {
                    "value": "[parameters('aksResourceGroup')]"
                  },
                  "namespaceName": {
                    "value": "[parameters('namespaceName')]"
                  },
                  "serviceName": {
                    "value": "[parameters('serviceName')]"
                  },
                  "loadBalancerServiceName": {
                    "value": "[parameters('loadBalancerServiceName')]"
                  },
                  "dnsLabel": {
                    "value": "[parameters('dnsLabelPrefix')]"
                  },
                  "identityId": {
                    "value": "[parameters('identityId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "2214744026105791490"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "metadata": {
                        "description": "Azure region for deployment scripts"
                      }
                    },
                    "aksClusterName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the AKS cluster"
                      }
                    },
                    "aksResourceGroup": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource group containing the AKS cluster"
                      }
                    },
                    "namespaceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Kubernetes namespace"
                      }
                    },
                    "serviceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name for the headless service"
                      }
                    },
                    "loadBalancerServiceName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name for the LoadBalancer service"
                      }
                    },
                    "dnsLabel": {
                      "type": "string",
                      "metadata": {
                        "description": "DNS label for the LoadBalancer service"
                      }
                    },
                    "identityId": {
                      "type": "string",
                      "metadata": {
                        "description": "Managed identity for deployment script"
                      }
                    }
                  },
                  "variables": {
                    "headlessServiceYaml": "[format('apiVersion: v1\nkind: Service\nmetadata:\n  name: {0}\n  namespace: {1}\n  labels:\n    app: neo4j\n    component: core\nspec:\n  clusterIP: None\n  publishNotReadyAddresses: true\n  selector:\n    app: neo4j\n    component: core\n  ports:\n  - name: http\n    port: 7474\n    targetPort: 7474\n    protocol: TCP\n  - name: https\n    port: 7473\n    targetPort: 7473\n    protocol: TCP\n  - name: bolt\n    port: 7687\n    targetPort: 7687\n    protocol: TCP\n  - name: cluster-tx\n    port: 6000\n    targetPort: 6000\n    protocol: TCP\n  - name: cluster-raft\n    port: 7000\n    targetPort: 7000\n    protocol: TCP\n', parameters('serviceName'), parameters('namespaceName'))]",
                    "loadBalancerServiceYaml": "[format('apiVersion: v1\nkind: Service\nmetadata:\n  name: {0}\n  namespace: {1}\n  labels:\n    app: neo4j\n    component: core\n  annotations:\n    service.beta.kubernetes.io/azure-dns-label-name: \"{2}\"\n    service.beta.kubernetes.io/azure-load-balancer-health-probe-interval: \"10\"\nspec:\n  type: LoadBalancer\n  sessionAffinity: ClientIP\n  sessionAffinityConfig:\n    clientIP:\n      timeoutSeconds: 10800\n  selector:\n    app: neo4j\n    component: core\n  ports:\n  - name: http\n    port: 7474\n    targetPort: 7474\n    protocol: TCP\n  - name: bolt\n    port: 7687\n    targetPort: 7687\n    protocol: TCP\n', parameters('loadBalancerServiceName'), parameters('namespaceName'), parameters('dnsLabel'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[format('create-services-{0}', uniqueString(resourceGroup().id, parameters('namespaceName')))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('identityId'))]": {}
                        }
                      },
                      "properties": {
                        "azCliVersion": "2.50.0",
                        "timeout": "PT10M",
                        "retentionInterval": "PT1H",
                        "environmentVariables": [
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "AKS_RESOURCE_GROUP",
                            "value": "[parameters('aksResourceGroup')]"
                          },
                          {
                            "name": "HEADLESS_SERVICE_YAML",
                            "value": "[variables('headlessServiceYaml')]"
                          },
                          {
                            "name": "LOADBALANCER_SERVICE_YAML",
                            "value": "[variables('loadBalancerServiceYaml')]"
                          }
                        ],
                        "scriptContent": "      #!/bin/bash\n      set -e\n\n      echo \"Installing kubectl...\"\n      az aks install-cli\n\n      echo \"Getting AKS credentials...\"\n      az aks get-credentials --name $AKS_CLUSTER_NAME --resource-group $AKS_RESOURCE_GROUP --overwrite-existing\n\n      echo \"Creating headless service...\"\n      echo \"$HEADLESS_SERVICE_YAML\" | kubectl apply -f -\n\n      echo \"Creating LoadBalancer service...\"\n      echo \"$LOADBALANCER_SERVICE_YAML\" | kubectl apply -f -\n\n      echo \"Verifying services...\"\n      kubectl get service -n ${namespaceName}\n\n      echo \"Services created successfully\"\n    ",
                        "cleanupPreference": "OnSuccess"
                      }
                    },
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2023-08-01",
                      "name": "[format('get-external-ip-{0}', uniqueString(resourceGroup().id, parameters('namespaceName')))]",
                      "location": "[parameters('location')]",
                      "kind": "AzureCLI",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('identityId'))]": {}
                        }
                      },
                      "properties": {
                        "azCliVersion": "2.50.0",
                        "timeout": "PT10M",
                        "retentionInterval": "PT1H",
                        "environmentVariables": [
                          {
                            "name": "AKS_CLUSTER_NAME",
                            "value": "[parameters('aksClusterName')]"
                          },
                          {
                            "name": "AKS_RESOURCE_GROUP",
                            "value": "[parameters('aksResourceGroup')]"
                          },
                          {
                            "name": "LOADBALANCER_SERVICE_NAME",
                            "value": "[parameters('loadBalancerServiceName')]"
                          },
                          {
                            "name": "NAMESPACE_NAME",
                            "value": "[parameters('namespaceName')]"
                          }
                        ],
                        "scriptContent": "      #!/bin/bash\n      set -e\n\n      echo \"Installing kubectl...\"\n      az aks install-cli\n\n      echo \"Getting AKS credentials...\"\n      az aks get-credentials --name $AKS_CLUSTER_NAME --resource-group $AKS_RESOURCE_GROUP --overwrite-existing\n\n      echo \"Getting external IP...\"\n      EXTERNAL_IP=$(kubectl get service $LOADBALANCER_SERVICE_NAME -n $NAMESPACE_NAME -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo \"pending\")\n\n      echo \"External IP: $EXTERNAL_IP\"\n\n      # Output as JSON for Bicep to parse\n      echo \"{\\\"externalIp\\\": \\\"$EXTERNAL_IP\\\"}\" > $AZ_SCRIPTS_OUTPUT_PATH\n    ",
                        "cleanupPreference": "OnSuccess"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Resources/deploymentScripts', format('create-services-{0}', uniqueString(resourceGroup().id, parameters('namespaceName'))))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "serviceName": {
                      "type": "string",
                      "value": "[parameters('serviceName')]"
                    },
                    "loadBalancerServiceName": {
                      "type": "string",
                      "value": "[parameters('loadBalancerServiceName')]"
                    },
                    "externalIp": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('get-external-ip-{0}', uniqueString(resourceGroup().id, parameters('namespaceName')))), '2023-08-01').outputs.externalIp]"
                    },
                    "deploymentStatus": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', format('create-services-{0}', uniqueString(resourceGroup().id, parameters('namespaceName')))), '2023-08-01').provisioningState]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'statefulset-deployment')]"
              ]
            }
          ],
          "outputs": {
            "namespaceName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'namespace-deployment'), '2025-04-01').outputs.namespaceName.value]"
            },
            "serviceAccountName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'serviceaccount-deployment'), '2025-04-01').outputs.serviceAccountName.value]"
            },
            "configMapName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'configuration-deployment'), '2025-04-01').outputs.configMapName.value]"
            },
            "secretName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'configuration-deployment'), '2025-04-01').outputs.secretName.value]"
            },
            "statefulSetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'statefulset-deployment'), '2025-04-01').outputs.statefulSetName.value]"
            },
            "serviceName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'services-deployment'), '2025-04-01').outputs.serviceName.value]"
            },
            "loadBalancerServiceName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'services-deployment'), '2025-04-01').outputs.loadBalancerServiceName.value]"
            },
            "externalIp": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'services-deployment'), '2025-04-01').outputs.externalIp.value]"
            },
            "neo4jBrowserUrl": {
              "type": "string",
              "value": "[format('http://{0}:7474', reference(resourceId('Microsoft.Resources/deployments', 'services-deployment'), '2025-04-01').outputs.externalIp.value)]"
            },
            "neo4jBoltUri": {
              "type": "string",
              "value": "[format('neo4j://{0}:7687', reference(resourceId('Microsoft.Resources/deployments', 'services-deployment'), '2025-04-01').outputs.externalIp.value)]"
            }
          }
        }
      },
      "dependsOn": [
        "aksCluster",
        "identity",
        "storage"
      ]
    }
  },
  "outputs": {
    "aksClusterName": {
      "type": "string",
      "value": "[reference('aksCluster').outputs.clusterName.value]"
    },
    "aksClusterId": {
      "type": "string",
      "value": "[reference('aksCluster').outputs.clusterId.value]"
    },
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "oidcIssuerUrl": {
      "type": "string",
      "value": "[reference('aksCluster').outputs.oidcIssuerUrl.value]"
    },
    "managedIdentityClientId": {
      "type": "string",
      "value": "[reference('identity').outputs.clientId.value]"
    },
    "managedIdentityPrincipalId": {
      "type": "string",
      "value": "[reference('identity').outputs.principalId.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[reference('aksCluster').outputs.logAnalyticsWorkspaceId.value]"
    },
    "nodeResourceGroup": {
      "type": "string",
      "value": "[reference('aksCluster').outputs.nodeResourceGroup.value]"
    },
    "neo4jNamespace": {
      "type": "string",
      "value": "[reference('neo4jApp').outputs.namespaceName.value]"
    },
    "neo4jStatefulSet": {
      "type": "string",
      "value": "[reference('neo4jApp').outputs.statefulSetName.value]"
    },
    "neo4jExternalIp": {
      "type": "string",
      "value": "[reference('neo4jApp').outputs.externalIp.value]"
    },
    "neo4jBrowserUrl": {
      "type": "string",
      "value": "[reference('neo4jApp').outputs.neo4jBrowserUrl.value]"
    },
    "neo4jBoltUri": {
      "type": "string",
      "value": "[reference('neo4jApp').outputs.neo4jBoltUri.value]"
    },
    "neo4jUsername": {
      "type": "string",
      "value": "neo4j"
    },
    "neo4jPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Neo4j admin password"
      },
      "value": "[parameters('adminPassword')]"
    },
    "connectionInstructions": {
      "type": "string",
      "value": "# Neo4j on AKS Deployed Successfully!\n\n## Connection Information\nBrowser URL:  ${neo4jApp.outputs.neo4jBrowserUrl}\nBolt URI:     ${neo4jApp.outputs.neo4jBoltUri}\nUsername:     neo4j\nPassword:     (provided during deployment)\n\nDeployment Type: ${deploymentType}\nNeo4j Version:   ${graphDatabaseVersion}\nNode Count:      ${nodeCount}\nLicense Type:    ${licenseType}\n\n## Access Neo4j Browser\nOpen the Browser URL in your web browser and login with the credentials above.\n\nNote: It may take 5-10 minutes for Neo4j pods to be fully ready after deployment.\n\n## Verify Deployment\nGet AKS credentials:\naz aks get-credentials --name ${aksCluster.outputs.clusterName} --resource-group ${resourceGroup().name}\n\nCheck Neo4j pods:\nkubectl get pods -n ${namespacePrefix} -w\n\nView Neo4j logs:\nkubectl logs neo4j-0 -n ${namespacePrefix}\n\nCheck services:\nkubectl get services -n ${namespacePrefix}\n\n## Troubleshooting\nIf you cannot connect:\n1. Wait a few minutes for pods to be ready\n2. Check pod status: kubectl describe pod neo4j-0 -n ${namespacePrefix}\n3. Verify external IP: kubectl get service neo4j-lb -n ${namespacePrefix}\n\n## Cleanup\nTo delete all resources:\n./delete.sh ${resourceGroup().name}\n"
    }
  }
}
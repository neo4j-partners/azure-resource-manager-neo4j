{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "2447567909032852131"
    }
  },
  "parameters": {
    "adminUsername": {
      "type": "string",
      "defaultValue": "neo4j",
      "metadata": {
        "description": "Admin username for SSH access to VMs."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Admin password for Neo4j VMs."
      }
    },
    "vmSize": {
      "type": "string"
    },
    "graphDatabaseVersion": {
      "type": "string",
      "allowedValues": [
        "5"
      ]
    },
    "licenseType": {
      "type": "string",
      "defaultValue": "Enterprise"
    },
    "nodeCount": {
      "type": "int",
      "allowedValues": [
        1,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10
      ]
    },
    "diskSize": {
      "type": "int"
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    }
  },
  "variables": {
    "deploymentUniqueId": "[uniqueString(resourceGroup().id, deployment().name)]",
    "resourceSuffix": "[variables('deploymentUniqueId')]",
    "loadBalancerCondition": "[greaterOrEquals(parameters('nodeCount'), 3)]",
    "cloudInitStandalone": "#cloud-config\n# Neo4j Enterprise 5 Standalone Deployment\n# This cloud-init configuration installs and configures Neo4j on a single Azure VM\n\n# Disable firewalld and SELinux\nbootcmd:\n  - systemctl stop firewalld\n  - systemctl disable firewalld\n  - setenforce 0\n  - sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config\n\n# Format and mount data disk\ndisk_setup:\n  /dev/disk/azure/scsi1/lun0:\n    table_type: gpt\n    layout: true\n    overwrite: false\n\nfs_setup:\n  - device: /dev/disk/azure/scsi1/lun0\n    partition: 1\n    filesystem: xfs\n\nmounts:\n  - [\"/dev/disk/azure/scsi1/lun0-part1\", \"/var/lib/neo4j\", \"xfs\", \"defaults\", \"0\", \"0\"]\n\n# Install Neo4j\nyum_repos:\n  neo4j:\n    name: Neo4j Yum Repo\n    baseurl: https://yum.neo4j.com/stable/5\n    enabled: true\n    gpgcheck: true\n    gpgkey: https://debian.neo4j.com/neotechnology.gpg.key\n\n# Run configuration commands\nruncmd:\n  # Import Neo4j GPG key and install\n  - rpm --import https://debian.neo4j.com/neotechnology.gpg.key\n  - export NEO4J_ACCEPT_LICENSE_AGREEMENT=${license_agreement}\n  - dnf install -y neo4j-enterprise\n\n  # Set license agreement for Neo4j service\n  - mkdir -p /etc/systemd/system/neo4j.service.d\n  - |\n    cat > /etc/systemd/system/neo4j.service.d/license.conf <<EOF\n    [Service]\n    Environment=\"NEO4J_ACCEPT_LICENSE_AGREEMENT=${license_agreement}\"\n    EOF\n  - systemctl daemon-reload\n\n  # Get instance metadata\n  - INSTANCE_METADATA=$(curl -H Metadata:true \"http://169.254.169.254/metadata/instance/compute?api-version=2017-03-01\")\n  - NODE_INDEX=$(echo $INSTANCE_METADATA | jq -r \".name\" | sed 's/.*_//')\n  - PRIVATE_IP=$(hostname -i | awk '{print $NF}')\n  - UNIQUE_STRING=\"${unique_string}\"\n  - LOCATION=\"${location}\"\n  - PUBLIC_HOSTNAME=\"vm${NODE_INDEX}.neo4j-${UNIQUE_STRING}.${LOCATION}.cloudapp.azure.com\"\n\n  # Install APOC plugin\n  - mv /var/lib/neo4j/labs/apoc-*-core.jar /var/lib/neo4j/plugins/\n\n  # Configure Neo4j network settings\n  - sed -i 's/#server.default_listen_address=0.0.0.0/server.default_listen_address=0.0.0.0/g' /etc/neo4j/neo4j.conf\n  - sed -i \"s/#server.default_advertised_address=localhost/server.default_advertised_address=${PUBLIC_HOSTNAME}/g\" /etc/neo4j/neo4j.conf\n  - sed -i \"s/#server.bolt.advertised_address=:7687/server.bolt.advertised_address=${PUBLIC_HOSTNAME}:7687/g\" /etc/neo4j/neo4j.conf\n  - sed -i 's/#server.bolt.listen_address=:7687/server.bolt.listen_address=0.0.0.0:7687/g' /etc/neo4j/neo4j.conf\n\n  # Configure extensions and security\n  - sed -i 's~#server.unmanaged_extension_classes=org.neo4j.examples.server.unmanaged=/examples/unmanaged~server.unmanaged_extension_classes=com.neo4j.bloom.server=/bloom,semantics.extension=/rdf~g' /etc/neo4j/neo4j.conf\n  - sed -i 's/#dbms.security.procedures.unrestricted=my.extensions.example,my.procedures.*/dbms.security.procedures.unrestricted=gds.*,apoc.*/g' /etc/neo4j/neo4j.conf\n  - echo \"dbms.security.http_auth_allowlist=/,/browser.*,/bloom.*\" >> /etc/neo4j/neo4j.conf\n  - echo \"dbms.security.procedures.allowlist=apoc.*,gds.*,bloom.*\" >> /etc/neo4j/neo4j.conf\n\n  # Add memory recommendations\n  - neo4j-admin server memory-recommendation >> /etc/neo4j/neo4j.conf\n\n  # Configure routing for driver compatibility\n  - echo \"dbms.routing.default_router=SERVER\" >> /etc/neo4j/neo4j.conf\n\n  # SSRF protection\n  - echo \"internal.dbms.cypher_ip_blocklist=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,169.254.169.0/24,fc00::/7,fe80::/10,ff00::/8\" >> /etc/neo4j/neo4j.conf\n\n  # Decode and set admin password, then start Neo4j\n  # IMPORTANT: All password handling must be in ONE script block because\n  # shell variables don't persist across separate runcmd entries in cloud-init\n  - |\n    echo \"=== Password Configuration Started ===\"\n\n    # Decode base64-encoded password (safe from quote/escape issues)\n    PASSWORD_BASE64='${admin_password}'\n    ADMIN_PASSWORD=$(echo \"$PASSWORD_BASE64\" | base64 -d)\n\n    echo \"Password received and decoded successfully\"\n    echo \"=== Password Configuration Complete ===\"\n\n    # Set initial password BEFORE first start\n    echo \"Setting Neo4j initial password...\"\n    neo4j-admin dbms set-initial-password \"$ADMIN_PASSWORD\"\n    echo \"Neo4j initial password set successfully\"\n\n    # Enable and start Neo4j\n    systemctl enable neo4j\n    systemctl start neo4j\n\n  # Wait for Neo4j to be fully ready\n  - |\n    until curl -s -o /dev/null -w '%{http_code}' http://localhost:7474 | grep -q \"200\"; do\n      echo \"Waiting for Neo4j to be ready...\"\n      sleep 5\n    done\n  - echo \"Neo4j is ready!\"\n\nwrite_files:\n  - path: /var/log/neo4j-cloud-init.log\n    content: |\n      Neo4j cloud-init started at $(date)\n    append: true\n",
    "cloudInitCluster": "#cloud-config\n# Neo4j Enterprise 5 Cluster Deployment\n# This cloud-init configuration installs and configures Neo4j in cluster mode\n\n# Disable firewalld and SELinux\nbootcmd:\n  - systemctl stop firewalld\n  - systemctl disable firewalld\n  - setenforce 0\n  - sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config\n\n# Format and mount data disk\ndisk_setup:\n  /dev/disk/azure/scsi1/lun0:\n    table_type: gpt\n    layout: true\n    overwrite: false\n\nfs_setup:\n  - device: /dev/disk/azure/scsi1/lun0\n    partition: 1\n    filesystem: xfs\n\nmounts:\n  - [\"/dev/disk/azure/scsi1/lun0-part1\", \"/var/lib/neo4j\", \"xfs\", \"defaults\", \"0\", \"0\"]\n\n# Install Neo4j\nyum_repos:\n  neo4j:\n    name: Neo4j Yum Repo\n    baseurl: https://yum.neo4j.com/stable/5\n    enabled: true\n    gpgcheck: true\n    gpgkey: https://debian.neo4j.com/neotechnology.gpg.key\n\n# Run configuration commands\nruncmd:\n  # Import Neo4j GPG key and install\n  - rpm --import https://debian.neo4j.com/neotechnology.gpg.key\n  - export NEO4J_ACCEPT_LICENSE_AGREEMENT=${license_agreement}\n  - dnf install -y neo4j-enterprise\n\n  # Set license agreement for Neo4j service\n  - mkdir -p /etc/systemd/system/neo4j.service.d\n  - |\n    cat > /etc/systemd/system/neo4j.service.d/license.conf <<EOF\n    [Service]\n    Environment=\"NEO4J_ACCEPT_LICENSE_AGREEMENT=${license_agreement}\"\n    EOF\n  - systemctl daemon-reload\n\n  # Get instance metadata\n  - INSTANCE_METADATA=$(curl -H Metadata:true \"http://169.254.169.254/metadata/instance/compute?api-version=2017-03-01\")\n  - NODE_INDEX=$(echo $INSTANCE_METADATA | jq -r \".name\" | sed 's/.*_//')\n  - INTERNAL_HOSTNAME=$(hostname)\n  - PRIVATE_IP=$(hostname -i | awk '{print $NF}')\n  - UNIQUE_STRING=\"${unique_string}\"\n  - LOCATION=\"${location}\"\n  - NODE_COUNT=${node_count}\n\n  # Public DNS for external access\n  - PUBLIC_HOSTNAME=\"vm${NODE_INDEX}.neo4j-${UNIQUE_STRING}.${LOCATION}.cloudapp.azure.com\"\n\n  # Generate cluster discovery endpoints using port 6000 (Neo4j 5.x cluster communication port)\n  - |\n    DISCOVERY_ENDPOINTS=\"\"\n    for i in $(seq 0 $((NODE_COUNT - 1))); do\n      if [ -n \"$DISCOVERY_ENDPOINTS\" ]; then\n        DISCOVERY_ENDPOINTS=\"${DISCOVERY_ENDPOINTS},\"\n      fi\n      DISCOVERY_ENDPOINTS=\"${DISCOVERY_ENDPOINTS}node$(printf '%06d' $i):6000\"\n    done\n    echo \"Generated cluster discovery endpoints: $DISCOVERY_ENDPOINTS\"\n\n  # Install APOC plugin\n  - mv /var/lib/neo4j/labs/apoc-*-core.jar /var/lib/neo4j/plugins/\n\n  # Configure Neo4j network settings\n  - sed -i 's/#server.default_listen_address=0.0.0.0/server.default_listen_address=0.0.0.0/g' /etc/neo4j/neo4j.conf\n  - sed -i \"s/#server.default_advertised_address=localhost/server.default_advertised_address=${INTERNAL_HOSTNAME}/g\" /etc/neo4j/neo4j.conf\n  - sed -i \"s/#server.bolt.advertised_address=:7687/server.bolt.advertised_address=${PUBLIC_HOSTNAME}:7687/g\" /etc/neo4j/neo4j.conf\n  - sed -i 's/#server.bolt.listen_address=:7687/server.bolt.listen_address=0.0.0.0:7687/g' /etc/neo4j/neo4j.conf\n\n  # Configure cluster mode\n  - echo \"server.cluster.system_database_mode=PRIMARY\" >> /etc/neo4j/neo4j.conf\n\n  # Neo4j 5.x Cluster Configuration (correct ports per official docs)\n  # Cluster communication / transaction shipping - port 6000\n  - echo \"server.cluster.advertised_address=${INTERNAL_HOSTNAME}:6000\" >> /etc/neo4j/neo4j.conf\n  - echo \"server.cluster.listen_address=0.0.0.0:6000\" >> /etc/neo4j/neo4j.conf\n\n  # Raft consensus protocol - port 7000\n  - echo \"server.cluster.raft.advertised_address=${INTERNAL_HOSTNAME}:7000\" >> /etc/neo4j/neo4j.conf\n  - echo \"server.cluster.raft.listen_address=0.0.0.0:7000\" >> /etc/neo4j/neo4j.conf\n\n  # Cluster discovery endpoints - use V2 discovery (recommended for Neo4j 5.23+)\n  - echo \"dbms.cluster.discovery.version=V2_ONLY\" >> /etc/neo4j/neo4j.conf\n  - echo \"dbms.cluster.discovery.v2.endpoints=${DISCOVERY_ENDPOINTS}\" >> /etc/neo4j/neo4j.conf\n  - echo \"dbms.cluster.minimum_initial_system_primaries_count=${NODE_COUNT}\" >> /etc/neo4j/neo4j.conf\n\n  # Configure extensions and security\n  - sed -i 's~#server.unmanaged_extension_classes=org.neo4j.examples.server.unmanaged=/examples/unmanaged~server.unmanaged_extension_classes=com.neo4j.bloom.server=/bloom,semantics.extension=/rdf~g' /etc/neo4j/neo4j.conf\n  - sed -i 's/#dbms.security.procedures.unrestricted=my.extensions.example,my.procedures.*/dbms.security.procedures.unrestricted=gds.*,apoc.*/g' /etc/neo4j/neo4j.conf\n  - echo \"dbms.security.http_auth_allowlist=/,/browser.*,/bloom.*\" >> /etc/neo4j/neo4j.conf\n  - echo \"dbms.security.procedures.allowlist=apoc.*,gds.*,bloom.*\" >> /etc/neo4j/neo4j.conf\n\n  # Add memory recommendations\n  - neo4j-admin server memory-recommendation >> /etc/neo4j/neo4j.conf\n\n  # Configure routing for driver compatibility\n  - echo \"dbms.routing.default_router=SERVER\" >> /etc/neo4j/neo4j.conf\n\n  # SSRF protection\n  - echo \"internal.dbms.cypher_ip_blocklist=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,169.254.169.0/24,fc00::/7,fe80::/10,ff00::/8\" >> /etc/neo4j/neo4j.conf\n\n  # Decode and set admin password, then start Neo4j\n  # IMPORTANT: All password handling must be in ONE script block because\n  # shell variables don't persist across separate runcmd entries in cloud-init\n  - |\n    echo \"=== Password Configuration Started ===\"\n\n    # Decode base64-encoded password (safe from quote/escape issues)\n    PASSWORD_BASE64='${admin_password}'\n    ADMIN_PASSWORD=$(echo \"$PASSWORD_BASE64\" | base64 -d)\n\n    echo \"Password received and decoded successfully\"\n    echo \"=== Password Configuration Complete ===\"\n\n    # Set initial password BEFORE first start\n    echo \"Setting Neo4j initial password...\"\n    neo4j-admin dbms set-initial-password \"$ADMIN_PASSWORD\"\n    echo \"Neo4j initial password set successfully\"\n\n    # Enable and start Neo4j\n    systemctl enable neo4j\n    systemctl start neo4j\n\n  # Wait for Neo4j to be fully ready\n  - |\n    until curl -s -o /dev/null -w '%{http_code}' http://localhost:7474 | grep -q \"200\"; do\n      echo \"Waiting for Neo4j to be ready...\"\n      sleep 5\n    done\n  - echo \"Neo4j cluster node is ready!\"\n\nwrite_files:\n  - path: /var/log/neo4j-cloud-init.log\n    content: |\n      Neo4j cluster cloud-init started at $(date)\n    append: true\n",
    "passwordBase64": "[base64(parameters('adminPassword'))]",
    "cloudInitTemplate": "[if(equals(parameters('nodeCount'), 1), variables('cloudInitStandalone'), variables('cloudInitCluster'))]",
    "licenseAgreement": "[if(equals(parameters('licenseType'), 'Evaluation'), 'eval', 'yes')]",
    "cloudInitStep1": "[replace(variables('cloudInitTemplate'), '${unique_string}', variables('deploymentUniqueId'))]",
    "cloudInitStep2": "[replace(variables('cloudInitStep1'), '${location}', parameters('location'))]",
    "cloudInitStep3": "[replace(variables('cloudInitStep2'), '${admin_password}', variables('passwordBase64'))]",
    "cloudInitStep4": "[replace(variables('cloudInitStep3'), '${license_agreement}', variables('licenseAgreement'))]",
    "cloudInitStep5": "[replace(variables('cloudInitStep4'), '${node_count}', string(parameters('nodeCount')))]",
    "cloudInitData": "[variables('cloudInitStep5')]",
    "cloudInitBase64": "[base64(variables('cloudInitData'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceSuffix": {
            "value": "[variables('resourceSuffix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9454814586337953316"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "resourceSuffix": {
              "type": "string"
            }
          },
          "variables": {
            "networkSGName": "[format('nsg-neo4j-{0}-{1}', parameters('location'), parameters('resourceSuffix'))]",
            "vnetName": "[format('vnet-neo4j-{0}-{1}', parameters('location'), parameters('resourceSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2025-01-01",
              "name": "[variables('networkSGName')]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "SSH",
                    "properties": {
                      "description": "SSH",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "HTTPS",
                    "properties": {
                      "description": "HTTPS",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7473",
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 101,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "HTTP",
                    "properties": {
                      "description": "HTTP",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7474",
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 102,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Bolt",
                    "properties": {
                      "description": "Bolt",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7687",
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 103,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "ClusterCommunication",
                    "properties": {
                      "description": "Cluster communication and transaction shipping (Neo4j 5.x)",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "6000",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 104,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "ClusterRaft",
                    "properties": {
                      "description": "Raft consensus protocol (Neo4j 5.x)",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7000",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 105,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "BoltRouting",
                    "properties": {
                      "description": "Bolt routing connector for cluster-aware drivers",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "7688",
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 106,
                      "direction": "Inbound"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2025-01-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "10.0.0.0/8"
                  ]
                },
                "subnets": [
                  {
                    "name": "subnet",
                    "properties": {
                      "addressPrefix": "10.0.0.0/16",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSGName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSGName'))]"
              ]
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "subnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2025-01-01').subnets[0].id]"
            },
            "nsgId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSGName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "identity-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceSuffix": {
            "value": "[variables('resourceSuffix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "5771663905982224295"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "resourceSuffix": {
              "type": "string"
            }
          },
          "variables": {
            "userAssignedIdentityName": "[format('usermanaged-neo4j-{0}-{1}', parameters('location'), parameters('resourceSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2024-11-30",
              "name": "[variables('userAssignedIdentityName')]",
              "location": "[parameters('location')]"
            }
          ],
          "outputs": {
            "identityId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
            },
            "identityPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')), '2024-11-30').principalId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "loadbalancer-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceSuffix": {
            "value": "[variables('resourceSuffix')]"
          },
          "loadBalancerCondition": {
            "value": "[variables('loadBalancerCondition')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10304150212285854123"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "resourceSuffix": {
              "type": "string"
            },
            "loadBalancerCondition": {
              "type": "bool"
            }
          },
          "variables": {
            "loadBalancerName": "[format('lb-neo4j-{0}-{1}', parameters('location'), parameters('resourceSuffix'))]",
            "publicIpName": "[format('ip-neo4j-{0}-{1}', parameters('location'), parameters('resourceSuffix'))]"
          },
          "resources": [
            {
              "condition": "[parameters('loadBalancerCondition')]",
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2025-01-01",
              "name": "[variables('publicIpName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "zones": [
                "2",
                "3",
                "1"
              ],
              "properties": {
                "ipTags": [
                  {
                    "ipTagType": "RoutingPreference",
                    "tag": "Internet"
                  }
                ],
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "dnsSettings": {
                  "domainNameLabel": "[format('neo4j-lb-{0}', parameters('resourceSuffix'))]"
                }
              }
            },
            {
              "condition": "[parameters('loadBalancerCondition')]",
              "type": "Microsoft.Network/loadBalancers",
              "apiVersion": "2025-01-01",
              "name": "[variables('loadBalancerName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "backendAddressPools": [
                  {
                    "name": "backend"
                  }
                ],
                "frontendIPConfigurations": [
                  {
                    "name": "lbipnew",
                    "properties": {
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
                      }
                    }
                  }
                ],
                "loadBalancingRules": [
                  {
                    "name": "inboundrule7474",
                    "properties": {
                      "frontendIPConfiguration": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIpConfigurations', variables('loadBalancerName'), 'lbipnew')]"
                      },
                      "frontendPort": 7474,
                      "backendPort": 7474,
                      "enableFloatingIP": false,
                      "idleTimeoutInMinutes": 4,
                      "protocol": "Tcp",
                      "enableTcpReset": false,
                      "loadDistribution": "Default",
                      "disableOutboundSnat": true,
                      "backendAddressPool": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerName'), 'backend')]"
                      },
                      "backendAddressPools": [
                        {
                          "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerName'), 'backend')]"
                        }
                      ],
                      "probe": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('loadBalancerName'), 'httpprobe')]"
                      }
                    }
                  },
                  {
                    "name": "inbound7687",
                    "properties": {
                      "frontendIPConfiguration": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIpConfigurations', variables('loadBalancerName'), 'lbipnew')]"
                      },
                      "frontendPort": 7687,
                      "backendPort": 7687,
                      "enableFloatingIP": false,
                      "idleTimeoutInMinutes": 4,
                      "protocol": "Tcp",
                      "enableTcpReset": false,
                      "loadDistribution": "Default",
                      "disableOutboundSnat": true,
                      "backendAddressPool": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerName'), 'backend')]"
                      },
                      "backendAddressPools": [
                        {
                          "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerName'), 'backend')]"
                        }
                      ],
                      "probe": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('loadBalancerName'), 'boltprobe')]"
                      }
                    }
                  }
                ],
                "probes": [
                  {
                    "name": "httpprobe",
                    "properties": {
                      "protocol": "Http",
                      "port": 7474,
                      "requestPath": "/",
                      "intervalInSeconds": 5,
                      "numberOfProbes": 1,
                      "probeThreshold": 1
                    }
                  },
                  {
                    "name": "boltprobe",
                    "properties": {
                      "protocol": "Tcp",
                      "port": 7687,
                      "intervalInSeconds": 5,
                      "numberOfProbes": 1,
                      "probeThreshold": 1
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
              ]
            }
          ],
          "outputs": {
            "loadBalancerBackendAddressPools": {
              "type": "array",
              "value": "[if(parameters('loadBalancerCondition'), reference(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '2025-01-01').backendAddressPools, createArray())]"
            },
            "publicIpAddress": {
              "type": "string",
              "value": "[if(parameters('loadBalancerCondition'), reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName')), '2025-01-01').ipAddress, '')]"
            },
            "publicIpFqdn": {
              "type": "string",
              "value": "[if(parameters('loadBalancerCondition'), reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName')), '2025-01-01').dnsSettings.fqdn, '')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "vmss-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceSuffix": {
            "value": "[variables('resourceSuffix')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "graphDatabaseVersion": {
            "value": "[parameters('graphDatabaseVersion')]"
          },
          "licenseType": {
            "value": "[parameters('licenseType')]"
          },
          "nodeCount": {
            "value": "[parameters('nodeCount')]"
          },
          "vmSize": {
            "value": "[parameters('vmSize')]"
          },
          "diskSize": {
            "value": "[parameters('diskSize')]"
          },
          "cloudInitBase64": {
            "value": "[variables('cloudInitBase64')]"
          },
          "identityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity-deployment'), '2025-04-01').outputs.identityId.value]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.subnetId.value]"
          },
          "loadBalancerBackendAddressPools": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'loadbalancer-deployment'), '2025-04-01').outputs.loadBalancerBackendAddressPools.value]"
          },
          "loadBalancerCondition": {
            "value": "[variables('loadBalancerCondition')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11478774421434152306"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "resourceSuffix": {
              "type": "string"
            },
            "adminUsername": {
              "type": "string"
            },
            "adminPassword": {
              "type": "securestring"
            },
            "graphDatabaseVersion": {
              "type": "string"
            },
            "licenseType": {
              "type": "string"
            },
            "nodeCount": {
              "type": "int"
            },
            "vmSize": {
              "type": "string"
            },
            "diskSize": {
              "type": "int"
            },
            "cloudInitBase64": {
              "type": "string"
            },
            "identityId": {
              "type": "string"
            },
            "subnetId": {
              "type": "string"
            },
            "loadBalancerBackendAddressPools": {
              "type": "array"
            },
            "loadBalancerCondition": {
              "type": "bool"
            }
          },
          "variables": {
            "vmScaleSetsName": "[format('vmss-neo4j-{0}-{1}', parameters('location'), parameters('resourceSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachineScaleSets",
              "apiVersion": "2025-04-01",
              "name": "[variables('vmScaleSetsName')]",
              "location": "[parameters('location')]",
              "tags": {
                "Neo4jVersion": "[parameters('graphDatabaseVersion')]",
                "Neo4jEdition": "[parameters('licenseType')]",
                "NodeCount": "[string(parameters('nodeCount'))]",
                "DeployedBy": "arm-template",
                "TemplateVersion": "1.0.0"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identityId'))]": {}
                }
              },
              "plan": {
                "publisher": "neo4j",
                "product": "neo4j-ee-vm",
                "name": "byol"
              },
              "sku": {
                "name": "[parameters('vmSize')]",
                "capacity": "[parameters('nodeCount')]"
              },
              "properties": {
                "overprovision": false,
                "upgradePolicy": {
                  "mode": "Manual"
                },
                "virtualMachineProfile": {
                  "storageProfile": {
                    "osDisk": {
                      "createOption": "FromImage"
                    },
                    "imageReference": {
                      "publisher": "Neo4j",
                      "offer": "neo4j-ee-vm",
                      "sku": "byol",
                      "version": "latest"
                    },
                    "dataDisks": [
                      {
                        "lun": 0,
                        "createOption": "Empty",
                        "managedDisk": {
                          "storageAccountType": "Premium_LRS"
                        },
                        "caching": "None",
                        "diskSizeGB": "[parameters('diskSize')]"
                      }
                    ]
                  },
                  "osProfile": {
                    "computerNamePrefix": "node",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "customData": "[parameters('cloudInitBase64')]"
                  },
                  "networkProfile": {
                    "networkInterfaceConfigurations": [
                      {
                        "name": "nic",
                        "properties": {
                          "primary": true,
                          "ipConfigurations": [
                            {
                              "name": "ipconfig-cluster",
                              "properties": {
                                "subnet": {
                                  "id": "[parameters('subnetId')]"
                                },
                                "publicIPAddressConfiguration": {
                                  "name": "public",
                                  "properties": {
                                    "idleTimeoutInMinutes": 30,
                                    "dnsSettings": {
                                      "domainNameLabel": "[format('neo4j-{0}', parameters('resourceSuffix'))]"
                                    }
                                  }
                                },
                                "loadBalancerBackendAddressPools": "[if(parameters('loadBalancerCondition'), parameters('loadBalancerBackendAddressPools'), null())]"
                              }
                            }
                          ]
                        }
                      }
                    ]
                  },
                  "extensionProfile": {
                    "extensions": []
                  }
                }
              }
            }
          ],
          "outputs": {
            "vmScaleSetsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('vmScaleSetsName'))]"
            },
            "vmScaleSetsName": {
              "type": "string",
              "value": "[variables('vmScaleSetsName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'loadbalancer-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    }
  ],
  "outputs": {
    "vnetId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetId.value]"
    },
    "subnetId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.subnetId.value]"
    },
    "nsgId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.nsgId.value]"
    },
    "identityId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identity-deployment'), '2025-04-01').outputs.identityId.value]"
    },
    "loadBalancerBackendAddressPools": {
      "type": "array",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'loadbalancer-deployment'), '2025-04-01').outputs.loadBalancerBackendAddressPools.value]"
    },
    "publicIpAddress": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'loadbalancer-deployment'), '2025-04-01').outputs.publicIpAddress.value]"
    },
    "vmScaleSetsId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vmss-deployment'), '2025-04-01').outputs.vmScaleSetsId.value]"
    },
    "vmScaleSetsName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vmss-deployment'), '2025-04-01').outputs.vmScaleSetsName.value]"
    },
    "Neo4jBrowserURL": {
      "type": "string",
      "value": "[uri(format('http://vm0.neo4j-{0}.{1}.cloudapp.azure.com:7474', variables('deploymentUniqueId'), parameters('location')), '')]"
    },
    "Neo4jClusterBrowserURL": {
      "type": "string",
      "value": "[if(variables('loadBalancerCondition'), uri(format('http://{0}:7474', reference(resourceId('Microsoft.Resources/deployments', 'loadbalancer-deployment'), '2025-04-01').outputs.publicIpFqdn.value), ''), '')]"
    },
    "Username": {
      "type": "string",
      "value": "neo4j"
    }
  }
}
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "6371182267077307639"
    }
  },
  "parameters": {
    "adminPassword": {
      "type": "securestring"
    },
    "vmSize": {
      "type": "string"
    },
    "readReplicaVmSize": {
      "type": "string",
      "defaultValue": "Standard_B2s"
    },
    "graphDatabaseVersion": {
      "type": "string",
      "allowedValues": [
        "5",
        "4.4"
      ]
    },
    "installGraphDataScience": {
      "type": "string",
      "defaultValue": "No"
    },
    "licenseType": {
      "type": "string",
      "defaultValue": "Enterprise"
    },
    "graphDataScienceLicenseKey": {
      "type": "string",
      "defaultValue": "None"
    },
    "installBloom": {
      "type": "string",
      "defaultValue": "No"
    },
    "bloomLicenseKey": {
      "type": "string"
    },
    "nodeCount": {
      "type": "int",
      "allowedValues": [
        1,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10
      ]
    },
    "readReplicaCount": {
      "type": "int",
      "defaultValue": 0,
      "allowedValues": [
        0,
        1,
        2,
        3,
        4,
        5,
        6,
        7,
        8,
        9,
        10
      ]
    },
    "diskSize": {
      "type": "int"
    },
    "readReplicaDiskSize": {
      "type": "int",
      "defaultValue": 32
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "utcValue": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional UTC value for testing. Leave empty for deterministic deployments."
      }
    }
  },
  "variables": {
    "scriptsBaseUrl": "https://raw.githubusercontent.com/neo4j-partners/azure-resource-manager-neo4j/main/",
    "deploymentUniqueId": "[uniqueString(resourceGroup().id, deployment().name)]",
    "resourceSuffix": "[if(not(equals(parameters('utcValue'), '')), parameters('utcValue'), variables('deploymentUniqueId'))]",
    "loadBalancerBackendAddressPools": [
      {
        "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerName'), 'backend')]"
      }
    ],
    "networkSGName": "[format('nsg-neo4j-{0}-{1}', parameters('location'), variables('resourceSuffix'))]",
    "vnetName": "[format('vnet-neo4j-{0}-{1}', parameters('location'), variables('resourceSuffix'))]",
    "loadBalancerName": "[format('lb-neo4j-{0}-{1}', parameters('location'), variables('resourceSuffix'))]",
    "publicIpName": "[format('ip-neo4j-{0}-{1}', parameters('location'), variables('resourceSuffix'))]",
    "vmScaleSetsName": "[format('vmss-neo4j-{0}-{1}', parameters('location'), variables('resourceSuffix'))]",
    "readReplicaVmScaleSetsName": "[format('read-replica-vmss-neo4j-{0}-{1}', parameters('location'), variables('resourceSuffix'))]",
    "userAssignedIdentityName": "[format('usermanaged-neo4j-{0}-{1}', parameters('location'), variables('resourceSuffix'))]",
    "azLoginIdentity": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/{2}', subscription().subscriptionId, resourceGroup().name, variables('userAssignedIdentityName'))]",
    "scriptName": "[if(equals(parameters('graphDatabaseVersion'), '5'), 'scripts/neo4j-enterprise/node.sh', 'scripts/neo4j-enterprise/node4.sh')]",
    "bashCommand": "[if(equals(parameters('graphDatabaseVersion'), '5'), 'bash node.sh ', 'bash node4.sh ')]",
    "adminUsername": "[string('neo4j')]",
    "doubleQuote": "\"",
    "readReplicaEnabledCondition": "[and(greaterOrEquals(parameters('readReplicaCount'), 1), equals(parameters('graphDatabaseVersion'), '4.4'))]",
    "loadBalancerCondition": "[or(greaterOrEquals(parameters('nodeCount'), 3), variables('readReplicaEnabledCondition'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2022-07-01",
      "name": "[variables('networkSGName')]",
      "location": "[parameters('location')]",
      "properties": {
        "securityRules": [
          {
            "name": "SSH",
            "properties": {
              "description": "SSH",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "22",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound"
            }
          },
          {
            "name": "HTTPS",
            "properties": {
              "description": "HTTPS",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "7473",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 101,
              "direction": "Inbound"
            }
          },
          {
            "name": "HTTP",
            "properties": {
              "description": "HTTP",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "7474",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 102,
              "direction": "Inbound"
            }
          },
          {
            "name": "Bolt",
            "properties": {
              "description": "Bolt",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "7687",
              "sourceAddressPrefix": "Internet",
              "destinationAddressPrefix": "*",
              "access": "Allow",
              "priority": 103,
              "direction": "Inbound"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2022-07-01",
      "name": "[variables('vnetName')]",
      "location": "[parameters('location')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "10.0.0.0/8"
          ]
        },
        "subnets": [
          {
            "name": "subnet",
            "properties": {
              "addressPrefix": "10.0.0.0/16",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSGName'))]"
              }
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSGName'))]"
      ]
    },
    {
      "condition": "[variables('loadBalancerCondition')]",
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2022-05-01",
      "name": "[variables('publicIpName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard",
        "tier": "Regional"
      },
      "zones": [
        "2",
        "3",
        "1"
      ],
      "properties": {
        "ipTags": [
          {
            "ipTagType": "RoutingPreference",
            "tag": "Internet"
          }
        ],
        "publicIPAddressVersion": "IPv4",
        "publicIPAllocationMethod": "Static"
      }
    },
    {
      "condition": "[variables('loadBalancerCondition')]",
      "type": "Microsoft.Network/loadBalancers",
      "apiVersion": "2022-05-01",
      "name": "[variables('loadBalancerName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard",
        "tier": "Regional"
      },
      "properties": {
        "backendAddressPools": [
          {
            "name": "backend"
          }
        ],
        "frontendIPConfigurations": [
          {
            "name": "lbipnew",
            "properties": {
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
              }
            }
          }
        ],
        "loadBalancingRules": [
          {
            "name": "inboundrule7474",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIpConfigurations', variables('loadBalancerName'), 'lbipnew')]"
              },
              "frontendPort": 7474,
              "backendPort": 7474,
              "enableFloatingIP": false,
              "idleTimeoutInMinutes": 4,
              "protocol": "Tcp",
              "enableTcpReset": false,
              "loadDistribution": "Default",
              "disableOutboundSnat": true,
              "backendAddressPool": {
                "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerName'), 'backend')]"
              },
              "backendAddressPools": [
                {
                  "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerName'), 'backend')]"
                }
              ],
              "probe": {
                "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('loadBalancerName'), 'httpprobe')]"
              }
            }
          },
          {
            "name": "inbound7687",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIpConfigurations', variables('loadBalancerName'), 'lbipnew')]"
              },
              "frontendPort": 7687,
              "backendPort": 7687,
              "enableFloatingIP": false,
              "idleTimeoutInMinutes": 4,
              "protocol": "Tcp",
              "enableTcpReset": false,
              "loadDistribution": "Default",
              "disableOutboundSnat": true,
              "backendAddressPool": {
                "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerName'), 'backend')]"
              },
              "backendAddressPools": [
                {
                  "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadBalancerName'), 'backend')]"
                }
              ],
              "probe": {
                "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('loadBalancerName'), 'boltprobe')]"
              }
            }
          }
        ],
        "probes": [
          {
            "name": "httpprobe",
            "properties": {
              "protocol": "Http",
              "port": 7474,
              "requestPath": "/",
              "intervalInSeconds": 5,
              "numberOfProbes": 1,
              "probeThreshold": 1
            }
          },
          {
            "name": "boltprobe",
            "properties": {
              "protocol": "Tcp",
              "port": 7687,
              "intervalInSeconds": 5,
              "numberOfProbes": 1,
              "probeThreshold": 1
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
      ]
    },
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2018-11-30",
      "name": "[variables('userAssignedIdentityName')]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Compute/virtualMachineScaleSets",
      "apiVersion": "2018-06-01",
      "name": "[variables('vmScaleSetsName')]",
      "location": "[parameters('location')]",
      "tags": {
        "Neo4jVersion": "[parameters('graphDatabaseVersion')]",
        "Neo4jEdition": "[parameters('licenseType')]",
        "NodeCount": "[string(parameters('nodeCount'))]",
        "DeployedBy": "arm-template",
        "TemplateVersion": "1.0.0"
      },
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')))]": {}
        }
      },
      "plan": {
        "publisher": "neo4j",
        "product": "neo4j-ee-vm",
        "name": "byol"
      },
      "sku": {
        "name": "[parameters('vmSize')]",
        "capacity": "[parameters('nodeCount')]"
      },
      "properties": {
        "overprovision": false,
        "upgradePolicy": {
          "mode": "Manual"
        },
        "virtualMachineProfile": {
          "storageProfile": {
            "osDisk": {
              "createOption": "FromImage"
            },
            "imageReference": {
              "publisher": "Neo4j",
              "offer": "neo4j-ee-vm",
              "sku": "byol",
              "version": "latest"
            },
            "dataDisks": [
              {
                "lun": 0,
                "createOption": "Empty",
                "managedDisk": {
                  "storageAccountType": "Premium_LRS"
                },
                "caching": "None",
                "diskSizeGB": "[parameters('diskSize')]"
              }
            ]
          },
          "osProfile": {
            "computerNamePrefix": "node",
            "adminUsername": "[variables('adminUsername')]",
            "adminPassword": "[parameters('adminPassword')]"
          },
          "networkProfile": {
            "networkInterfaceConfigurations": [
              {
                "name": "nic",
                "properties": {
                  "primary": true,
                  "ipConfigurations": [
                    {
                      "name": "ipconfig-cluster",
                      "properties": {
                        "subnet": {
                          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), 'subnet')]"
                        },
                        "publicIPAddressConfiguration": {
                          "name": "public",
                          "properties": {
                            "idleTimeoutInMinutes": 30,
                            "dnsSettings": {
                              "domainNameLabel": "[format('node-{0}', variables('deploymentUniqueId'))]"
                            }
                          }
                        },
                        "loadBalancerBackendAddressPools": "[if(variables('loadBalancerCondition'), variables('loadBalancerBackendAddressPools'), null())]"
                      }
                    }
                  ]
                }
              }
            ]
          },
          "extensionProfile": {
            "extensions": [
              {
                "name": "extension",
                "properties": {
                  "publisher": "Microsoft.Azure.Extensions",
                  "type": "CustomScript",
                  "typeHandlerVersion": "2.0",
                  "autoUpgradeMinorVersion": true,
                  "settings": {
                    "fileUris": [
                      "[format('{0}{1}', variables('scriptsBaseUrl'), variables('scriptName'))]"
                    ]
                  },
                  "protectedSettings": {
                    "commandToExecute": "[format('{0}{1} {2}{3}{4} {5} {6} {7} {8} {9} {10} {11} {12} {13}{14} {15} {16} {17} {18}', variables('bashCommand'), variables('adminUsername'), variables('doubleQuote'), parameters('adminPassword'), variables('doubleQuote'), variables('deploymentUniqueId'), parameters('location'), parameters('graphDatabaseVersion'), parameters('installGraphDataScience'), parameters('graphDataScienceLicenseKey'), parameters('installBloom'), parameters('bloomLicenseKey'), parameters('nodeCount'), if(equals(parameters('graphDatabaseVersion'), '4.4'), format('{0} ', parameters('readReplicaCount')), ''), if(variables('loadBalancerCondition'), reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName')), '2022-05-01').ipAddress, '-'), variables('azLoginIdentity'), resourceGroup().name, variables('vmScaleSetsName'), if(equals(parameters('graphDatabaseVersion'), '5'), parameters('licenseType'), ''))]"
                  }
                }
              }
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]"
      ]
    },
    {
      "condition": "[variables('readReplicaEnabledCondition')]",
      "type": "Microsoft.Compute/virtualMachineScaleSets",
      "apiVersion": "2018-06-01",
      "name": "[variables('readReplicaVmScaleSetsName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName')))]": {}
        }
      },
      "plan": {
        "publisher": "neo4j",
        "product": "neo4j-ee-vm",
        "name": "byol"
      },
      "sku": {
        "name": "[parameters('readReplicaVmSize')]",
        "capacity": "[parameters('readReplicaCount')]"
      },
      "properties": {
        "overprovision": false,
        "upgradePolicy": {
          "mode": "Manual"
        },
        "virtualMachineProfile": {
          "storageProfile": {
            "osDisk": {
              "createOption": "FromImage"
            },
            "imageReference": {
              "publisher": "Neo4j",
              "offer": "neo4j-ee-vm",
              "sku": "byol",
              "version": "latest"
            },
            "dataDisks": [
              {
                "lun": 0,
                "createOption": "Empty",
                "managedDisk": {
                  "storageAccountType": "Premium_LRS"
                },
                "caching": "None",
                "diskSizeGB": "[parameters('readReplicaDiskSize')]"
              }
            ]
          },
          "osProfile": {
            "computerNamePrefix": "node",
            "adminUsername": "[variables('adminUsername')]",
            "adminPassword": "[parameters('adminPassword')]"
          },
          "networkProfile": {
            "networkInterfaceConfigurations": [
              {
                "name": "nic-read-replica",
                "properties": {
                  "primary": true,
                  "ipConfigurations": [
                    {
                      "name": "ipconfig-read-replica",
                      "properties": {
                        "subnet": {
                          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), 'subnet')]"
                        },
                        "publicIPAddressConfiguration": {
                          "name": "public-read-replica",
                          "properties": {
                            "idleTimeoutInMinutes": 30,
                            "dnsSettings": {
                              "domainNameLabel": "[format('rr-{0}', variables('deploymentUniqueId'))]"
                            }
                          }
                        },
                        "loadBalancerBackendAddressPools": "[variables('loadBalancerBackendAddressPools')]"
                      }
                    }
                  ]
                }
              }
            ]
          },
          "extensionProfile": {
            "extensions": [
              {
                "name": "extension",
                "properties": {
                  "publisher": "Microsoft.Azure.Extensions",
                  "type": "CustomScript",
                  "typeHandlerVersion": "2.0",
                  "autoUpgradeMinorVersion": true,
                  "settings": {
                    "fileUris": [
                      "[format('{0}scripts/neo4j-enterprise/readreplica4.sh', variables('scriptsBaseUrl'))]"
                    ]
                  },
                  "protectedSettings": {
                    "commandToExecute": "[format('bash readreplica4.sh {0}{1}{2} {3} {4} {5} {6} {7} {8} {9}', variables('doubleQuote'), parameters('adminPassword'), variables('doubleQuote'), variables('azLoginIdentity'), resourceGroup().name, variables('vmScaleSetsName'), parameters('installGraphDataScience'), parameters('graphDataScienceLicenseKey'), parameters('installBloom'), parameters('bloomLicenseKey'))]"
                  }
                }
              }
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('userAssignedIdentityName'))]",
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('vmScaleSetsName'))]"
      ]
    }
  ],
  "outputs": {
    "Neo4jBrowserURL": {
      "type": "string",
      "value": "[uri(format('http://vm0.node-{0}.{1}.cloudapp.azure.com:7474', variables('deploymentUniqueId'), parameters('location')), '')]"
    },
    "Neo4jClusterBrowserURL": {
      "type": "string",
      "value": "[uri(format('http://{0}:7474', reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName')), '2022-05-01').ipAddress), '')]"
    },
    "Neo4jClusterBloomURL": {
      "type": "string",
      "value": "[uri(format('http://{0}:7474', reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName')), '2022-05-01').ipAddress), 'bloom')]"
    },
    "Neo4jBloomURL": {
      "type": "string",
      "value": "[uri(format('http://vm0.node-{0}.{1}.cloudapp.azure.com:7474', variables('deploymentUniqueId'), parameters('location')), 'bloom')]"
    },
    "Username": {
      "type": "string",
      "value": "neo4j"
    }
  }
}
#!/bin/bash
#
# Pre-commit hook for Bicep file validation
# This hook validates all staged .bicep files using Azure Bicep CLI
#
# To install this hook, run:
#   cp scripts/pre-commit-bicep .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# To bypass this hook in an emergency, use:
#   git commit --no-verify
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running Bicep linter on staged files..."

# Check if Azure Bicep CLI is installed
if ! command -v az bicep &> /dev/null; then
    echo -e "${RED}ERROR: Azure Bicep CLI is not installed or not in PATH${NC}"
    echo "Please install Azure CLI and Bicep CLI before committing Bicep files."
    echo "See docs/DEVELOPMENT_SETUP.md for installation instructions."
    exit 1
fi

# Get list of staged .bicep files
STAGED_BICEP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.bicep$' || true)

# If no Bicep files are staged, exit successfully
if [ -z "$STAGED_BICEP_FILES" ]; then
    echo -e "${GREEN}No Bicep files to validate.${NC}"
    exit 0
fi

echo "Validating the following Bicep files:"
echo "$STAGED_BICEP_FILES" | sed 's/^/  - /'
echo

# Track if any files fail validation
VALIDATION_FAILED=0
FAILED_FILES=()

# Validate each staged Bicep file
for FILE in $STAGED_BICEP_FILES; do
    # Skip if file doesn't exist (deleted file)
    if [ ! -f "$FILE" ]; then
        continue
    fi

    echo "Validating: $FILE"

    # Run Bicep build (includes linting)
    if az bicep build --file "$FILE" --stdout 2>&1 > /dev/null; then
        echo -e "  ${GREEN}✓ Passed${NC}"
    else
        echo -e "  ${RED}✗ Failed${NC}"
        VALIDATION_FAILED=1
        FAILED_FILES+=("$FILE")

        # Show the actual errors for this file
        echo -e "${YELLOW}Errors in $FILE:${NC}"
        az bicep build --file "$FILE" 2>&1 | grep -E "(Error|Warning)" || true
        echo
    fi
done

echo

# If any validation failed, exit with error
if [ $VALIDATION_FAILED -eq 1 ]; then
    echo -e "${RED}❌ Bicep validation failed for the following files:${NC}"
    for FAILED_FILE in "${FAILED_FILES[@]}"; do
        echo "  - $FAILED_FILE"
    done
    echo
    echo "Please fix the errors above before committing."
    echo "To bypass this hook (NOT RECOMMENDED), use: git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}✅ All Bicep files passed validation!${NC}"
exit 0
